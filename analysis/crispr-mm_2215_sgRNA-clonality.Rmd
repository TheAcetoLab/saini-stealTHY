---
title: "Clonal dynamics using mock CRISPR screen"
subtitle: "Mouse libray (n = 2215)"
author: "Francesc Castro-Giner"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params:
  data_dir: ./data/crispr/mm_2215_sgRNA
---

## Load libraries, additional functions and data

Setup environment
```{r setup, include=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(results='asis', echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.align = 'center', fig.width = 3.5, fig.asp = 0.618, dpi = 600, dev = c("png", "pdf"), fig.showtext = FALSE, engine.opts = list(bash = "-l"))

options(stringsAsFactors = FALSE)

use_seed <- 1100101

set.seed(use_seed)
```

Load packages
```{r load-libraries}
library(tidyverse)
library(knitr)
library(foreach)
library(magrittr)
library(DT)
library(kableExtra)
library(diptest)
library(SummarizedExperiment)

library(ggridges)
library(ggh4x)
library(patchwork)
library(colorblindr)
library(ggbeeswarm)
library(ggpubr)
```

Load ggplot theme
```{r ggplot-theme}
source("./configuration/rmarkdown/ggplot_theme.R")
```

Load ggplot theme
```{r color-palette}
source("./configuration/rmarkdown/color_palettes.R")
```

Load Summarized Experiment object
```{r load-se}
se <- readRDS(file.path(params$data_dir, 'se.rds'))
```

Filter samples used for this analysis
```{r dw-sel-cols}
use_cols <- colData(se) %>% 
  data.frame %>% 
  filter(effect_type_short == 'noKO') %>% 
  filter(vector_short != "Thy1_EF1alpha_dCas9") %>% 
  rownames

se <- se[,use_cols]
```

Data wrangling
```{r dw-colData}
chunk_colData <- colData(se) %>% data.frame %>%
  mutate(
    vector_short = ifelse(vector_short == 'Puro_EF1alpha_SpCas9', 
                          'Cas9+Puro', vector_short),
    vector_short = ifelse(vector_short == 'Puro+ dCas9', 
                          'Cas9+Puro', vector_short),
    vector_short = factor(vector_short, levels = c('Thy1', 'Puro', 'Cas9+Puro')),
    mouse_model_short = case_match(mouse_model_global,
                                   'immunodeficient' ~ 'NSG',
                                   'immunocompetent' ~ 'Syngeneic',
                                   'C57BL6' ~ 'Syngeneic'
                                   ),
    mouse_model_short = factor(mouse_model_short, levels = c('NSG', 'Syngeneic')),
    vector_mhost = paste0(vector_short, ', ', mouse_model_short),
    model_vector_mhost = paste0(donor,', ', vector_short, ', ', mouse_model_short),
    sample_type = ifelse(cancer_type %in% c('Breast', 'CRC'),
                         case_match(sample_type, 
                             'whole_tumor' ~ 'Primary tumor', 
                             'whole_lung' ~ 'Lung mets',
                             'bulk' ~ 'Bulk',
                             'cell_culture' ~ 'Cell culture'),
                         sample_type
                         ),
        sample_type = ifelse(cancer_type %in% c('NSCLC'),
                         case_match(sample_type, 
                             'met_liver' ~ 'Liver mets', 
                             'whole_lung' ~ 'Primary tumor',
                             'bulk' ~ 'Bulk',
                             'cell_culture' ~ 'Cell culture'),
                         sample_type
                         ),
    
    sample_type = factor(sample_type, levels = c('Primary tumor', 'Lung mets', 'Liver mets', 'Bulk', 'Cell culture'))
    
  )

colData(se) <- chunk_colData %>% DataFrame


```

## Configure analyses

Define comparisons for modality and Kolmogorov-Smirnov test
```{r define-comparisons-modality-ks}
x <- colData(se) %>% data.frame

group_list_modality <- list(
  `Syngeneic Thy1` = x %>% 
    filter(vector_mmodel == '4T1-noKO-Thy1-BALB' & sample_type == 'Primary tumor') %>% 
    pull(sample_alias),
  
  `Syngeneic Puro` = x %>% 
    filter(vector_mmodel %in% c('4T1-noKO-Puro-BALB', 'MVT1-noKO-Puro-FVB', 'Py2T-noKO-Puro-FVB') & sample_type == 'Primary tumor') %>%
    pull(sample_alias),
  
  `Syngeneic dCas9 + Puro` = x %>% 
    filter(vector_mmodel == '4T1-noKO-Puro_EF1alpha_dCas9-BALB' & sample_type == 'Primary tumor') %>% 
    pull(sample_alias),
  
  `NSG Thy1` =  x %>% 
    filter(vector_mmodel %in% c('4T1-noKO-Thy1-NSG', 'MVT1-noKO-Thy1-NSG', 'Py2T-noKO-Thy1-NSG') & sample_type == 'Primary tumor') %>%
    pull(sample_alias),
  
  `NSG Puro` = x %>% 
    filter(vector_mmodel %in% c('4T1-noKO-Puro-NSG', 'MVT1-noKO-Puro-NSG', 'Py2T-noKO-Puro-NSG') & sample_type == 'Primary tumor') %>%
    pull(sample_alias),
  
  `NSG dCas9 + Puro` = x %>% 
    filter(vector_mmodel == '4T1-noKO-Puro_EF1alpha_dCas9-NSG' & sample_type == 'Primary tumor') %>% 
    pull(sample_alias)
)

comp_list_modality <- list(
  `Syngeneic Thy1 vs. dCas9 + Puro` = list(
    `dCas9 + Puro` = group_list_modality$`Syngeneic dCas9 + Puro`,
    `Thy1` = group_list_modality$`Syngeneic Thy1`
  ),
  `Syngeneic Thy1 vs. Puro` = list(
    `Puro` = group_list_modality$`Syngeneic Puro`,
    `Thy1` = group_list_modality$`Syngeneic Thy1`
  )
)

group_df_modality <- foreach(i = names(group_list_modality), .combine = rbind) %do% {
  data.frame(
    sample_alias = group_list_modality[[i]],
    modality_group = i
  )
}
```


## sgRNA distribution in Primary tumor
```{r test-dist-tumor-conf}
use_sample_type <- 'Primary tumor'
use_colData <- colData(se) %>% data.frame %>%
  filter(sample_type == use_sample_type)
```

### Figure 2B: sgRNA distribution in mice transplanted with 4T1 cells

Density plots showing unique sgRNAs in 4T1 tumors (n=5); frequency = read counts per million (cpm+1).

```{r test-dist-tumor-distribution-ridges_plot-4t1, fig.width=3, fig.asp=1}
selected_panels <- list(
  `Thy1, NSG` = c('4T_TumoT_N4', '4T_TumoT_N5', '4T_TumoT_N2'),
  `Thy1, Syngeneic` = c('4T_TumoT_B1', '4T_TumoT_B3', '4T_TumoT_B4'),
 
  `Puro, NSG` = c('4T_TumoP_N5', '4T_TumoP_N4', '4T_TumoP_N2'),
  `Puro, Syngeneic` = c('4T_TumoP_B3', '4T_TumoP_B2', '4T_TumoP_B1'),
  
  `dCas9+Puro, NSG` = c('PlatePositionE1', 'PlatePositionC1', 'PlatePositionA2'),
  `dCas9+Puro, Syngeneic` = c('PlatePositionE2', 'PlatePositionG2', 'PlatePositionC2')
  
)

selected_panels_df <- foreach(i = names(selected_panels), .combine = rbind) %do% {
  data.frame(group = i, sample_alias = selected_panels[[i]])
}

use_samples <- unlist(selected_panels)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData) %>% 
  left_join(selected_panels_df) %>% 
  mutate(
    sample_alias = factor(sample_alias, levels = use_samples),
    group = factor(group, levels = names(selected_panels))
  )

use_assay %>% 
  ggplot(aes(x=cpm + 1, y = sample_alias, 
             fill = vector_short, color = vector_short, 
             height = after_stat(density))) +
  geom_density_ridges(size = one_pt/4, 
                      alpha = 0.8, 
                      scale = 4,
                      rel_min_height = 0.001 # set the `rel_min_height` argument to remove tails,
                      ) +
  scale_fill_manual(values = palette_vector) +
  scale_color_manual(values = palette_vector_line) +
  scale_x_log10(expand = expansion(mult = c(0, 0))) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none', color = 'none') +
  facet_wrap2(vars(group), ncol = 2,
                     scales = 'free_y',
                     axes = "x") +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.text.y = element_blank(),
    strip.text.x = element_text(size=4, hjust = 0)
  )
                                
```


### Supplementary Figure 2B: sgRNA distribution in mice transplanted with Py2T and MVT1 cells

Density plots showing the distribution of unique sgRNAs retrieved in primary tumors from the indicated mice transplanted with Py2T and MVT1 cells, previously transduced as indicated; frequency=read counts per million (cpm+1); each plot is representative of a group of n=5. 

```{r test-dist-tumor-distribution-ridges_plot-py2t-mvt1, fig.width=3, fig.asp=1.33}
selected_panels <- list(
  `Py2T, Thy1, NSG` = c('PY_TumoT_N5', 'PY_TumoT_N4', 'PY_TumoT_N3'),
  `Py2T, Thy1, Syngeneic` = c('PY_TumoT_F3', 'PY_TumoT_F4', 'PY_TumoT_F5'), 
  
  `Py2T, Puro, NSG` = c('PY_TumoP_N1', 'PY_TumoP_N2', 'PY_TumoP_N3'),
  `Py2T, Puro, Syngeneic` = c('PY_TumoP_F1', 'PY_TumoP_F5', 'PY_TumoP_F2'),
  
  `MVT1, Thy1, NSG` = c('MVT_TumoT_N3', 'MVT_TumoT_N4', 'MVT_TumoT_N5'),
  `MVT1, Thy1, Syngeneic` = c('MVT_TumoT_F1', 'MVT_TumoT_F4', 'MVT_TumoT_F3'),
  
  `MVT1, Puro, NSG` = c('MVT_TumoP_N3', 'MVT_TumoP_N4', 'MVT_TumoP_N5'),
  `MVT1, Puro, Syngeneic` = c('MVT_TumoP_F3', 'MVT_TumoP_F4', 'MVT_TumoP_F5')
)

selected_panels_df <- foreach(i = names(selected_panels), .combine = rbind) %do% {
  data.frame(group = i, sample_alias = selected_panels[[i]])
}

use_samples <- unlist(selected_panels)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData) %>% 
  left_join(selected_panels_df) %>% 
  mutate(
    sample_alias = factor(sample_alias, levels = use_samples),
    group = factor(group, levels = names(selected_panels))
  )

use_assay %>% 
  ggplot(aes(x=cpm + 1, y = sample_alias, 
             fill = vector_short, 
             color = vector_short, 
             height = after_stat(density))) +
  geom_density_ridges(size = one_pt/4, 
                      alpha = 0.8, 
                      scale = 4,
                      rel_min_height = 0.001 # set the `rel_min_height` argument to remove tails,
                      ) +
  scale_fill_manual(values = palette_vector) +
  scale_color_manual(values = palette_vector_line) +
  scale_x_log10(expand = expansion(mult = c(0, 0))) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none', color = 'none') +
  facet_wrap2(vars(group), ncol = 2,
                     scales = 'free_y',
                     axes = "x") +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.text.y = element_blank(),
    panel.border = element_rect(fill =NULL,
                                color = "black",
                                linewidth = 2*one_pt)
  )
                                
```


## Kolmogorov-Smirnov test and ECDF plots 

Run Kolmogorov-Smirnov test to compare distributions merged by group and create Empirical Cumulative Density Function (ECDF) by comparison.
```{r modality-comparisons-ks-ecdf-run}

i <- names(comp_list_modality)[1]
ks_test_df <- data.frame()
ecdf_plots <- list()
for(i in names(comp_list_modality)) {
  use_samples <- comp_list_modality[[i]]
  use_assay_c <- assay(se[,use_samples[[1]]], 'cpm') %>% 
    data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, values_to = 'cpm',names_to = 'sample_alias') %>% 
    mutate(group = 'case', condition = names(use_samples)[1])
  use_assay_r <- assay(se[,use_samples[[2]]], 'cpm') %>% 
    data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, values_to = 'cpm',names_to = 'sample_alias') %>% 
    mutate(group = 'referene', condition = names(use_samples)[2])
  use_assay <- rbind(use_assay_c, use_assay_r)
  
  # Perform the Kolmogorov-Smirnov test
  ks.res <- ks.test(use_assay_c$cpm, use_assay_r$cpm)
  ks_test_df <- rbind(
    ks_test_df,
      data.frame(
        comparison = i,
        case = names(use_samples)[1],
        reference = names(use_samples)[2],
        D = ks.res$statistic,
        P = ks.res$p.value
      )
    )

  # Create ECDFs plot Empirical Cumulative Density Function
  # use_colors <- c('red', 'blue') %>% set_names(names(use_samples))
  ecdf_plots[[i]] <- use_assay %>% 
    ggplot(aes(x = log(1+cpm), color = condition, group = sample_alias)) +
    stat_ecdf(geom = 'step', alpha = 1, linewidth = one_pt/4) +
    scale_color_manual(values = palette_vector) +
    labs(x = "log(1+cpm)",
         color = '',
         sub = i
         ) +
    theme(
      text = element_text(size=2),
      axis.text.y =  element_text(size=3),
      axis.text.x =  element_text(size=3),
      legend.text =  element_text(size=2),
      legend.title =  element_text(size=2),
      plot.subtitle = element_text(size=3),
      plot.caption =  element_text(size=2)
      
    )

}
```

### Supplementary Figure 2C left : K-S test table 

Table depicting the results of the Kolmogorov-Smirnov test for comparing sgRNA distributions from the datasets indicated, encompassing three mammary carcinoma models (MVT1, 4T1, Py2T). The datasets are obtained from primary tumors shown in Figure 2B and Supplementary Figure 2B.

```{r modality-comparisons-ks-table}
ks_test_df %>% 
  dplyr::select(-case, -reference) %>% 
  mutate(P = format.pval(P)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Results of Kolmogorov-Smirnov test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1)
              )
            )
            ) %>% 
    formatRound(columns = c('D'), digits = 3)
```

### Supplementary Figure 2C right : Empirical Cumulative Density Function (ECDF) plots

Cumulative curves depicting the results of the Kolmogorov-Smirnov test for comparing sgRNA distributions from the datasets indicated, encompassing three mammary carcinoma models (MVT1, 4T1, Py2T). The datasets are obtained from primary tumors shown in Figure 2B and Supplementary Figure 2B.

Empirical Cumulative Density Function (ECDF) plot by comparison
```{r modality-comparisons-ks-ecdf, fig.width = 3, fig.asp = 0.3}
use_index <- c("Syngeneic Thy1 vs. Puro", "Syngeneic Thy1 vs. dCas9 + Puro")
plot_grid(plotlist = ecdf_plots[use_index], ncol = 2)
```

## Figure 2C: Representative Müller plots of 4T1 in syngeneic recipients

Define selected comparisons for muller plots
```{r define-comparisons-muller-plots}
comp_list_muller_syngeneic_representative <- list(
 `Thy1` = c('4T_TumoT_B3', '4T_LungsT_B3'),
 `Puro` = c('4T_TumoP_B1', '4T_LungsP_B1'),
 `dCas9 + Puro` = c('PlatePositionA3', 'PlatePositionB3')
)
```

Generate muller plots
```{r run-muller-syngeneic-representative-plots}
cpm_threshold <- 10000
comp_list <- comp_list_muller_syngeneic_representative

use_df <- assay(se, 'cpm') %>% data.frame(check.names = FALSE) %>% 
  rownames_to_column('guide') %>% 
  mutate(
    gene = rowData(se)$Gene,
    gene = ifelse(grepl('Non_Target', gene), 'Non_Target', gene)
  ) %>%
  pivot_longer(-c(guide, gene), names_to = 'sample_alias', values_to = 'cpm')

j <-  names(comp_list)[1]
muller_plots <- foreach(j = names(comp_list)) %do% {
  i <- comp_list[[j]]
  x <- use_df %>% 
    filter(sample_alias %in% i) %>% 
    mutate(
      sample_type = ifelse(sample_alias == i[1], 'Primary tumor', 'Lungs'),
      sample_type = factor(sample_type, levels = c('Primary tumor', 'Lungs'))
    )
  
  # Select guides with cpm > cpm_threshold
  x_guides_keep <- x %>% 
    group_by(sample_type, guide) %>% 
    summarise(cpm = max(cpm)) %>% 
    filter(cpm > cpm_threshold) %>% 
    pull(guide)
  
  # Group guides with cpm < cpm_threshold into the low abundant category, and sum counts for low abundant
  x %<>% 
    mutate(
      guide = ifelse(guide %in%  x_guides_keep, guide, 'low abundant')
    ) %>% 
    group_by(sample_type, guide) %>%
    summarise(cpm = sum(cpm)) %>% 
    ungroup() %>%
    mutate(
      guide = fct_reorder(guide, cpm),
      guide = relevel(guide, ref = 'low abundant')
    )
  
  use_cols <- c(
    'low abundant' = 'grey80',
    colorRampPalette(rev(palette_OkabeIto))(nlevels(x$guide) - 1) %>% set_names(levels(x$guide)[-1])
  )
  
  x %>% 
    ggplot( aes(x = sample_type, y = cpm/10000, group = guide, fill = guide)) + 
    geom_area(colour = alpha("white", 0.1), linewidth = 0.08, alpha = 0.8) +
    scale_fill_manual(values = use_cols, guide = guide_legend(ncol = 3)) +
    labs(
      x = '',
      y = expression("CPM x 10"^-4),
      title = j,
      fill = ''
    ) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 1000000/10000)) +
    guides(fill = FALSE) +
    theme(
      panel.background = element_rect(fill = "grey90"),
      # plot.margin = margin(0.5, 1.5, 0.5, 0, "cm"),
      plot.margin = margin(0, 0.5, 0, 0, "cm"),
      axis.text =  element_text(size=3),
      axis.title =  element_text(size=3),
      plot.title = element_text(size=3, hjust = 0.5)
    )

}
names(muller_plots) <- names(comp_list)
muller_syngeneic_representative <- muller_plots
```


Muller plots comparing sgRNAs frequency in matched primary tumors versus lung metastases from syngeneic 4T1 transplants (n=5; representative shown). 

```{r muller-syngeneic-representative-plots, fig.width = 1.5, fig.asp = 2}
wrap_plots(muller_plots, ncol = 1)
```


## Hartigans' dip test
Hartigans' dip test for unimodality. If the p-value is less than 0.05, there's enough evidence to claim that the data are not unimodal (multimodal, at least bimodal).

```{r test-dip}
use_assay <- assay(se, 'cpm')
i <- colnames(use_assay)[1]
modality_test_df <- foreach(i= colnames(use_assay), .combine = rbind) %do%{
  x <- use_assay[,i]
  dip.res <- dip.test(x, simulate.p.value = FALSE, B = 2000)
  data.frame(
    sample_alias = i,
    dip.D = dip.res$statistic,
    dip.p = dip.res$p.value,
    dip.result = ifelse(dip.res$p.value < 0.05, 'multimodal', 'unimodal')
    )
}

modality_test_df %<>% 
  left_join(group_df_modality) %>% 
  left_join(colData(se) %>% data.frame)
  
```

### Dip test table for Syngeneic models
```{r test-dip-syngeneic-table}
modality_test_df %>% 
  filter(!is.na(modality_group)) %>% 
  filter(mouse_model_global == 'immunocompetent') %>% 
  mutate(
    modality_group = factor(modality_group, levels = names(group_list_modality))
  ) %>%
  group_by(modality_group) %>%
  summarise(
    `Median D` = median(dip.D) %>% round(3),
    n = n(),
    `Multimodal samples (n)` = sum(dip.result == 'multimodal'),
    `Unimodal samples (n)` = sum(dip.result == 'unimodal'),
    `Multimodal samples (%)` = round(100*`Multimodal samples (n)`/n, 1),
    `Unimodal samples (%)` = round(100*`Unimodal samples (n)`/n, 1)
  ) %>% 
  data.frame(check.names = F) %>% 
  kbl(caption = 'Dip test results for Syngeneic models') %>%
  kable_paper(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

### Dip test table for NSG models
```{r test-dip-nsg-table}
modality_test_df %>% 
  filter(!is.na(modality_group)) %>% 
  filter(mouse_model_global == 'immunodeficient') %>% 
  mutate(
    modality_group = factor(modality_group, levels = names(group_list_modality))
  ) %>%
  group_by(modality_group) %>%
  summarise(
    `Median D` = median(dip.D) %>% round(3),
    n = n(),
    `Multimodal samples (n)` = sum(dip.result == 'multimodal'),
    `Unimodal samples (n)` = sum(dip.result == 'unimodal'),
    `Multimodal samples (%)` = round(100*`Multimodal samples (n)`/n, 1),
    `Unimodal samples (%)` = round(100*`Unimodal samples (n)`/n, 1)
  ) %>% 
  data.frame(check.names = F) %>% 
  kbl(caption = 'Dip test results for NSG models') %>%
  kable_paper(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```



## Supplementary Figure 4C

Muller plots depicting the relative frequency of the predominant sgRNAs in matched primary tumors (mammary fat pad) versus synchronous metastasis samples (lungs) from syngeneic recipients transplanted with the indicated cell model, which received StealTHY KO of the mouse interactome library; n=5 each (representative samples are shown).

```{r muller-sf4-c, fig.width = 1.5, fig.asp=1}
se <- readRDS(file.path(params$data_dir, 'se.rds'))
comp_list <- list(
 `Condition KO Thy1_all immunocompetent TUMORS--vs--Condition KO Thy1_all immunocompetent Lungs mets`=c('CRISPRKO_Clone_14', 'CRISPRKO_Clone_19')
)

cpm_threshold <- 10000

use_df <- assay(se, 'cpm') %>% data.frame(check.names = FALSE) %>% 
  rownames_to_column('guide') %>% 
  mutate(
    gene = rowData(se)$Gene,
    gene = ifelse(grepl('Non_Target', gene), 'Non_Target', gene)
  ) %>%
  pivot_longer(-c(guide, gene), names_to = 'sample_alias', values_to = 'cpm')

j <-  names(comp_list)[1]
muller_plots <- foreach(j = names(comp_list)) %do% {
  i <- comp_list[[j]]
  x <- use_df %>% 
    filter(sample_alias %in% i) %>% 
    mutate(
      sample_type = ifelse(sample_alias == i[1], 'Primary tumor', 'Lungs'),
      sample_type = factor(sample_type, levels = c('Primary tumor', 'Lungs'))
    )
  
  # Select guides with cpm > cpm_threshold
  x_guides_keep <- x %>% 
    group_by(sample_type, guide) %>% 
    summarise(cpm = max(cpm)) %>% 
    filter(cpm > cpm_threshold) %>% 
    pull(guide)
  
  # Group guides with cpm < cpm_threshold into the low abundant category, and sum counts for low abundant
  x %<>% 
    mutate(
      guide = ifelse(guide %in%  x_guides_keep, guide, 'low abundant')
    ) %>% 
    group_by(sample_type, guide) %>%
    summarise(cpm = sum(cpm)) %>% 
    ungroup() %>%
    mutate(
      guide = fct_reorder(guide, cpm),
      guide = relevel(guide, ref = 'low abundant')
    )
  
  use_cols <- c(
    'low abundant' = 'grey80',
    colorRampPalette(rev(palette_OkabeIto))(nlevels(x$guide) - 1) %>% set_names(levels(x$guide)[-1])
  )
  
  x %>% 
    ggplot( aes(x = sample_type, y = cpm/10000, group = guide, fill = guide)) + 
    geom_area(colour = alpha("white", 0.1), linewidth = 0.08, alpha = 0.8) +
    scale_fill_manual(values = use_cols, guide = guide_legend(ncol = 3)) +
    labs(
      x = '',
      y = expression("CPM x 10"^-4),
      title = j,
      fill = ''
    ) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 1000000/10000)) +
    # guides(fill = FALSE) +
    theme(
        panel.background = element_rect(fill = "grey90"),
        plot.margin = margin(0, 0.5, 0, 0, "cm"),
        axis.text =  element_text(size=3),
        axis.title =  element_text(size=3),
        plot.title = element_text(size=3, hjust = 0.5),
        legend.text = element_text(size=3),
        legend.title = element_text(size=3),
        legend.position = 'bottom',
        legend.key.size = unit(0.1, 'cm'),
        legend.key.spacing.y = unit(0.1, 'mm'),
        legend.key.spacing.x = unit(0.1, 'mm')
    )

}

print(muller_plots)
```




## Supplementary Figure 2D Lower Panels

Muller plots depicting the relative frequency of unique sgRNAs in matched primary tumors (mammary or lung orthotopic) versus synchronous metastasis samples (lung metastasis for mammary tumors, liver metastasis for lung tumors) from syngeneic and NSG recipients transplanted with the indicated models previously transduced as indicated; n=5 per group (representative samples are shown).

```{r muller-sfig2-d-lower, fig.width = 2.5, fig.asp = 0.7}
se <- readRDS(file.path(params$data_dir, 'se.rds'))
comp_list <- list(
  `Condition Puro_all immunoDEFICIENT TUMORS--vs--Condition Puro_all immunoDEFICIENT Lungs mets` = list(
    MVT1 = c('MVT_TumoP_N1', 'MVT_LungsP_N1'), #muller-plots-67.png
    Py2T = c('PY_TumoP_N1', 'PY_LungsP_N1')#muller-plots-77.png
    ),
  `Condition Puro_all immunocompetent TUMORS--vs--Condition Puro_all immunocompetent Lungs mets` = list(
    MVT1 = c('MVT_TumoP_F5', 'MVT_LungsP_F5'), #muller-plots-19.png
    Py2T = c('PY_TumoP_F5', 'PY_LungsP_F5') #muller-plots-25.png
    ),
  `Condition Thy1_all immunoDEFICIENT TUMORS--vs--Condition Thy1_all immunoDEFICIENT Lungs mets` = list(
    MVT1 = c('MVT_TumoT_N1', 'MVT_LungsT_N1'), #muller-plots-127.png
    Py2T = c('PY_TumoT_N1', 'PY_LungsT_N1') #muller-plots-137.png
  ),
  `Condition Thy_all immunocompetent TUMORS--vs--Condition Thy_all immunocompetent Lungs mets` = list(
    MVT1 = c('MVT_TumoT_F2', 'MVT_LungsT_F2'), #muller-plots-39.png
    Py2T = c('PY_TumoT_F3', 'PY_LungsT_F3') #muller-plots-51.png
  )
  
)

cpm_threshold <- 10000


use_df <- assay(se, 'cpm') %>% data.frame(check.names = FALSE) %>% 
  rownames_to_column('guide') %>% 
  mutate(
    gene = rowData(se)$Gene,
    gene = ifelse(grepl('Non_Target', gene), 'Non_Target', gene)
  ) %>%
  pivot_longer(-c(guide, gene), names_to = 'sample_alias', values_to = 'cpm')

i <-  names(comp_list)[1]
muller_plots <- foreach(i = names(comp_list)) %do% {
  j <- comp_list[[i]][[1]]
  res <- foreach(j = comp_list[[i]]) %do% {
    x <- use_df %>% 
      filter(sample_alias %in% j) %>% 
      mutate(sample_alias = factor(sample_alias, j))
    
    # Select guides with cpm > cpm_threshold
    x_guides_keep <- x %>% 
      group_by(sample_alias, guide) %>% 
      summarise(cpm = max(cpm)) %>% 
      filter(cpm > cpm_threshold) %>% 
      pull(guide)
    
    # Group guides with cpm < cpm_threshold into the low abundant category, and sum counts for low abundant
    x %<>% 
      mutate(
         guide = ifelse(guide %in%  x_guides_keep, guide, 'low abundant')
      ) %>% 
      group_by(sample_alias, guide) %>%
      summarise(cpm = sum(cpm)) %>% 
      ungroup() %>%
      mutate(
        guide = gsub('_guide', ' sg', guide),
        guide = fct_reorder(guide, cpm),
        guide = relevel(guide, ref = 'low abundant')
      )
    
    use_cols <- c(
      'low abundant' = 'grey80',
      colorRampPalette(rev(palette_OkabeIto))(nlevels(x$guide) - 1) %>% set_names(levels(x$guide)[-1])
    )
    
    x %>% 
      ggplot( aes(x = sample_alias, y = cpm, group = guide, fill = guide)) + 
      geom_area(colour = alpha("white", 0.1), linewidth = 0.08, alpha = 0.8) +
      scale_fill_manual(values = use_cols, guide = guide_legend(ncol = 3)) +
      labs(
        x = '',
        y = 'cpm',
        fill = ''
      ) +
      theme(
        panel.background = element_rect(fill = "grey90"),
        # plot.margin = margin(0.5, 1.5, 0.5, 0, "cm"),
        plot.margin = margin(0, 0.5, 0, 0, "cm"),
        axis.text =  element_text(size=3),
        axis.title =  element_text(size=3),
        plot.title = element_text(size=3, hjust = 0.5),
        legend.text = element_text(size=3),
        legend.title = element_text(size=3),
        legend.position = 'bottom',
        legend.key.size = unit(0.1, 'cm'),
        legend.key.spacing.y = unit(0.1, 'mm'),
        legend.key.spacing.x = unit(0.1, 'mm')
      )+
      scale_x_discrete(expand = c(0, 0)) +
      scale_y_continuous(expand = c(0, 0), limits = c(0,1000000))
  }
  names(res) <- names(comp_list[[i]])
  res
}
names(muller_plots) <- names(comp_list)
```


### Supplementary Figure 2D (left lower)
```{r muller-sfig2-d-left-lower, fig.width = 2.5, fig.asp = 0.7}
plot_list <- list(
  muller_plots[['Condition Puro_all immunoDEFICIENT TUMORS--vs--Condition Puro_all immunoDEFICIENT Lungs mets']][['MVT1']] + guides(fill = 'none'),
  muller_plots[['Condition Puro_all immunocompetent TUMORS--vs--Condition Puro_all immunocompetent Lungs mets']][['MVT1']]+  guides(fill = 'none'),
  muller_plots[['Condition Puro_all immunoDEFICIENT TUMORS--vs--Condition Puro_all immunoDEFICIENT Lungs mets']][['Py2T']] + guides(fill = 'none'),
  muller_plots[['Condition Puro_all immunocompetent TUMORS--vs--Condition Puro_all immunocompetent Lungs mets']][['Py2T']]+  guides(fill = 'none')
)

wrap_plots(plot_list, ncol = 2, byrow = TRUE) %>% print
```

### Supplementary Figure 2D (right lower)
```{r muller-sfig2-d-right-lower, fig.width = 2.5, fig.asp = 0.7}
plot_list <- list(
  muller_plots[['Condition Thy1_all immunoDEFICIENT TUMORS--vs--Condition Thy1_all immunoDEFICIENT Lungs mets']][['MVT1']] + guides(fill = 'none'),
  muller_plots[['Condition Thy_all immunocompetent TUMORS--vs--Condition Thy_all immunocompetent Lungs mets']][['MVT1']]+  guides(fill = 'none'),
  muller_plots[['Condition Thy1_all immunoDEFICIENT TUMORS--vs--Condition Thy1_all immunoDEFICIENT Lungs mets']][['Py2T']] + guides(fill = 'none'),
  muller_plots[['Condition Thy_all immunocompetent TUMORS--vs--Condition Thy_all immunocompetent Lungs mets']][['Py2T']]+  guides(fill = 'none')
)

wrap_plots(plot_list, ncol = 2, byrow = TRUE) %>% print
```


## Other Müller plots

Define selected comparisons for muller plots
```{r define-comparisons-other-muller-plots}
x <- colData(se) %>% data.frame

comp_list_muller <- list(
  `Comparison 1: CMT167 Syngeneic Thy1.1` = list(
    `CMT167 Syngeneic Thy1.1 1` = c('C167_StealTHY_Tum_1',	'C167_StealTHY_Met_1'),
    `CMT167 Syngeneic Thy1.1 3` = c('C167_StealTHY_Tum_3',	'C167_StealTHY_Met_3'),
    `CMT167 Syngeneic Thy1.1 4` = c('C167_StealTHY_Tum_4',	'C167_StealTHY_Met_4'),
    `CMT167 Syngeneic Thy1.1 5` = c('C167_StealTHY_Tum_5',	'C167_StealTHY_Met_5')
  ),
  `Comparison 2: LLC1 Syngeneic Thy1.1` = list( 
   `LLC1 Syngeneic Thy1.1 1` =  c('LLC1_StealTHY_Tum_1',	'LLC1_StealTHY_Met_1'),
   `LLC1 Syngeneic Thy1.1 2` =  c('LLC1_StealTHY_Tum_2',	'LLC1_StealTHY_Met_2'),
   `LLC1 Syngeneic Thy1.1 3` =  c('LLC1_StealTHY_Tum_3',	'LLC1_StealTHY_Met_3'),
   `LLC1 Syngeneic Thy1.1 4` =  c('LLC1_StealTHY_Tum_4',	'LLC1_StealTHY_Met_4'),
   `LLC1 Syngeneic Thy1.1 5` =  c('LLC1_StealTHY_Tum_5',	'LLC1_StealTHY_Met_5')
  ),
  `Comparison 3: CT26 Syngeneic Thy1.1` = list( 
    `CT26 Syngeneic Thy1.1 1` = c('ColoCT26_StealTHY_Tum_1',	'ColoCT26_StealTHY_Met_1'),
    `CT26 Syngeneic Thy1.1 2` = c('ColoCT26_StealTHY_Tum_2',	'ColoCT26_StealTHY_Met_2'),
    `CT26 Syngeneic Thy1.1 3` = c('ColoCT26_StealTHY_Tum_3',	'Replacement_1'),
    `CT26 Syngeneic Thy1.1 4` = c('Replacement_2',	'Replacement_3'),
    `CT26 Syngeneic Thy1.1 5` = c('Replacement_4',	'Replacement_4bis')
  ),
  `Comparison 4: CMT167 Syngeneic dCas9 + Puro` = list(
    `CMT167 Syngeneic dCas9 + Puro 3` = c('dC9BL6_LungIV_C167_3',	'dC9BL6_LiverIV_C167_3'),
    `CMT167 Syngeneic dCas9 + Puro 5` = c('dC9BL6_LungIV_C167_5',	'dC9BL6_LiverIV_C167_5')
  ),
  
  `Comparison 5: LLC1 Syngeneic dCas9 + Puro` = list(
    `LLC1 Syngeneic dCas9 + Puro 1` = c('dC9BL6_LungIV_LLC1_1',	'dC9BL6_LiverIV_LLC1_1'),
    `LLC1 Syngeneic dCas9 + Puro 3` = c('dC9BL6_LungIV_LLC1_3',	'dC9BL6_LiverIV_LLC1_3'),
    `LLC1 Syngeneic dCas9 + Puro 4` = c('dC9BL6_LungIV_LLC1_4',	'dC9BL6_LiverIV_LLC1_4'),
    `LLC1 Syngeneic dCas9 + Puro 5` = c('dC9BL6_LungIV_LLC1_5',	'dC9BL6_LiverIV_LLC1_5')
  ),
  
  `Comparison 6: CMT167 NSG dCas9 + Puro` = list(
    `CMT167 NSG dCas9 + Puro 1` = c('dC9NSG_LungIV_C167_1',	'dC9NSG_LiverIV_C167_1'),
    `CMT167 NSG dCas9 + Puro 2` = c('dC9NSG_LungIV_C167_2',	'dC9NSG_LiverIV_C167_2'),
    `CMT167 NSG dCas9 + Puro 3` = c('dC9NSG_LungIV_C167_3',	'dC9NSG_LiverIV_C167_3'),
    `CMT167 NSG dCas9 + Puro 4` = c('dC9NSG_LungIV_C167_4',	'dC9NSG_LiverIV_C167_4'),
    `CMT167 NSG dCas9 + Puro 5` = c('dC9NSG_LungIV_C167_5',	'dC9NSG_LiverIV_C167_5')
  ),
  
  `Comparison 7: LLC1 NSG dCas9 + Puro` = list(
    `LLC1 NSG dCas9 + Puro 1` = c('dC9NSG_LungIV_LLC1_1',	'dC9NSG_LiverIV_LLC1_1'),
    `LLC1 NSG dCas9 + Puro 2` = c('dC9NSG_LungIV_LLC1_2',	'dC9NSG_LiverIV_LLC1_2'),
    `LLC1 NSG dCas9 + Puro 3` = c('dC9NSG_LungIV_LLC1_3',	'dC9NSG_LiverIV_LLC1_3'),
    `LLC1 NSG dCas9 + Puro 4` = c('dC9NSG_LungIV_LLC1_4',	'dC9NSG_LiverIV_LLC1_4'),
    `LLC1 NSG dCas9 + Puro 5` = c('dC9NSG_LungIV_LLC1_5',	'dC9NSG_LiverIV_LLC1_5')
  ),
  `Comparison 10: Thy1.1 in BL6` = list(
    `CMT167 BL6 Thy1.1` = c('Replacement_9',	'Replacement_1bis'),
    `LLC1 BL6 Thy1.1` = c('Replacement_5',	'Replacement_6')
  ),
  `Comparison 11: Thy1.1 in NSG` = list(
    `CMT167 NSG Thy1.1` = c('Replacement_2bis',	'Replacement_3bis'),
    `LLC1 NSG Thy1.1` = c('Replacement_7',	'Replacement_8')
  )
)


```

Generate muller plots
```{r run-other-muller-plots}
cpm_threshold <- 10000
comp_list <- comp_list_muller

use_df <- assay(se, 'cpm') %>% data.frame(check.names = FALSE) %>% 
  rownames_to_column('guide') %>% 
  mutate(
    gene = rowData(se)$Gene,
    gene = ifelse(grepl('Non_Target', gene), 'Non_Target', gene)
  ) %>%
  pivot_longer(-c(guide, gene), names_to = 'sample_alias', values_to = 'cpm')

j <-  names(comp_list)[1]
muller_plots <- foreach(j = names(comp_list)) %do% {
  i <- comp_list[[j]][[1]]
  res <- foreach(iname = names(comp_list[[j]])) %do% {
    i <- comp_list[[j]][[iname]]
    x <- use_df %>% 
      filter(sample_alias %in% i) %>% 
      mutate(
        sample_type = ifelse(sample_alias == i[1], 'Primary tumor', 'Metastasis'),
        sample_type = factor(sample_type, levels = c('Primary tumor', 'Metastasis'))
      )
    
    # Select guides with cpm > cpm_threshold
    x_guides_keep <- x %>% 
      group_by(sample_type, guide) %>% 
      summarise(cpm = max(cpm)) %>% 
      filter(cpm > cpm_threshold) %>% 
      pull(guide)
    
    # Group guides with cpm < cpm_threshold into the low abundant category, and sum counts for low abundant
    x %<>% 
      mutate(
        guide = ifelse(guide %in%  x_guides_keep, guide, 'low abundant')
      ) %>% 
      group_by(sample_type, guide) %>%
      summarise(cpm = sum(cpm)) %>% 
      ungroup() %>%
      mutate(
        guide = fct_reorder(guide, cpm),
        guide = relevel(guide, ref = 'low abundant')
      )
    
    use_cols <- c(
      'low abundant' = 'grey80',
      colorRampPalette(rev(palette_OkabeIto))(nlevels(x$guide) - 1) %>% set_names(levels(x$guide)[-1])
    )
    
    x %>% 
      ggplot( aes(x = sample_type, y = cpm/10000, group = guide, fill = guide)) + 
      geom_area(colour = alpha("white", 0.1), linewidth = 0.08, alpha = 0.8) +
      scale_fill_manual(values = use_cols, guide = guide_legend(ncol = 3)) +
      labs(
        x = '',
        y = expression("CPM x 10"^-4),
        title = iname,
        fill = ''
      ) +
      scale_x_discrete(expand = c(0, 0)) +
      scale_y_continuous(expand = c(0, 0), limits = c(0, 1000000/10000)) +
      guides(fill = guide_legend(nrow=8)) +
      theme(
        panel.background = element_rect(fill = "grey90"),
        # plot.margin = margin(0.5, 1.5, 0.5, 0, "cm"),
        plot.margin = margin(0, 0.5, 0, 0, "cm"),
        axis.text =  element_text(size=3),
        axis.title =  element_text(size=3),
        plot.title = element_text(size=3, hjust = 0.5),
        legend.text = element_text(size=3),
        legend.title = element_text(size=3),
        legend.position = 'bottom',
        legend.key.size = unit(0.1, 'cm'),
        legend.key.spacing.y = unit(0.1, 'mm'),
        legend.key.spacing.x = unit(0.1, 'mm')
      )
  }
  names(res) <- names(comp_list[[j]])
  return(res)

}
names(muller_plots) <- names(comp_list)
# muller_syngeneic_representative <- muller_plots
```

### Supplementary Figure 2D (left upper)

Muller plots depicting the relative frequency of unique sgRNAs in matched primary tumors (mammary or lung orthotopic) versus synchronous metastasis samples (lung metastasis for mammary tumors, liver metastasis for lung tumors) from syngeneic and NSG recipients transplanted with the indicated models previously transduced as indicated; n=5 per group (representative samples are shown).

```{r muller-sfig2-d-left-upper, fig.width = 2.5, fig.asp = 0.7}
plot_list <- list(
  muller_plots[['Comparison 7: LLC1 NSG dCas9 + Puro']][['LLC1 NSG dCas9 + Puro 2']] + guides(fill = 'none'),
  muller_plots[['Comparison 5: LLC1 Syngeneic dCas9 + Puro']][['LLC1 Syngeneic dCas9 + Puro 1']]+  guides(fill = 'none'),
  muller_plots[['Comparison 6: CMT167 NSG dCas9 + Puro']][['CMT167 NSG dCas9 + Puro 4']] + guides(fill = 'none') ,
  muller_plots[['Comparison 4: CMT167 Syngeneic dCas9 + Puro']][['CMT167 Syngeneic dCas9 + Puro 3']] + guides(fill = 'none')
)

wrap_plots(plot_list, ncol = 2, byrow = TRUE) %>% print
```

### Supplementary Figure 2D (right upper)

Muller plots depicting the relative frequency of unique sgRNAs in matched primary tumors (mammary or lung orthotopic) versus synchronous metastasis samples (lung metastasis for mammary tumors, liver metastasis for lung tumors) from syngeneic and NSG recipients transplanted with the indicated models previously transduced as indicated; n=5 per group (representative samples are shown).

```{r muller-sfig2-d-right-upper, fig.width = 2.5, fig.asp = 0.7}
plot_list <- list(
  muller_plots[['Comparison 11: Thy1.1 in NSG']][['LLC1 NSG Thy1.1']]+ guides(fill = 'none'),
  muller_plots[['Comparison 10: Thy1.1 in BL6']][['LLC1 BL6 Thy1.1']]+ guides(fill = 'none'),
  muller_plots[['Comparison 11: Thy1.1 in NSG']][['CMT167 NSG Thy1.1']]+ guides(fill = 'none'),
  muller_plots[['Comparison 10: Thy1.1 in BL6']][['CMT167 BL6 Thy1.1']]+ guides(fill = 'none')
)

wrap_plots(plot_list, ncol = 2, byrow = TRUE) %>% print
```

### Supplementary Figure 2F

Muller plot depicting the relative frequency of the predominant sgRNAs in matched primary tumors versus synchronous metastasis samples (lungs) from syngeneic recipients transplanted with CT26 cells, previously transduced with Thy1 as indicated; n=5 each (representative samples are shown).

```{r muller-sfig2-f, fig.width = 1.5}
print(muller_plots[['Comparison 3: CT26 Syngeneic Thy1.1']][['CT26 Syngeneic Thy1.1 3']] + guides(fill = 'none'))
```

### Supplementary Figure 4L

Application of StealTHY to syngeneic models of lung and colon carcinoma. Left: schematic representation of the in vivo CRISPR screen strategy to identify metastatic genes in immunocompetent mice, showing the experimental pipeline followed for each cancer type. Right: Muller plots depicting the relative frequency of the predominant sgRNAs in matched primary tumors (lung or colon orthotopic) versus synchronous metastasis samples (liver metastasis for lung tumors, lung metastasis for colon tumors) from syngeneic recipients transplanted with the indicated cell models, which received StealTHY KO of the mouse interactome library; n=5 each (representative samples are shown).

```{r muller-sfig4-l, fig.width = 1.5, fig.asp = 2}
plot_list <- list(
  muller_plots[['Comparison 2: LLC1 Syngeneic Thy1.1']][['LLC1 Syngeneic Thy1.1 4']],
  muller_plots[['Comparison 3: CT26 Syngeneic Thy1.1']][['CT26 Syngeneic Thy1.1 1']]
)

wrap_plots(plot_list, ncol = 1) %>% print

```




