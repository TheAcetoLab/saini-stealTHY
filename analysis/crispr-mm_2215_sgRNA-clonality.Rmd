---
title: "Clonal dynamics using mock CRISPR screen"
subtitle: "Mouse libray (n = 2215)"
author: "Francesc Castro-Giner"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params:
  data_dir: ./data/crispr/mm_2215_sgRNA
---

## Load libraries, additional functions and data

Setup environment
```{r setup, include=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(results='asis', echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.align = 'center', fig.width = 3.5, fig.asp = 0.618, dpi = 600, dev = c("png", "pdf"), fig.showtext = FALSE, engine.opts = list(bash = "-l"))

options(stringsAsFactors = FALSE)

use_seed <- 1100101

set.seed(use_seed)

# dir.create(params$output_dir, recursive = TRUE, showWarnings = FALSE)
```

Load packages
```{r load-libraries}
library(tidyverse)
library(knitr)
library(foreach)
library(magrittr)
library(DT)
library(kableExtra)
library(diptest)
library(SummarizedExperiment)

library(ggridges)
library(ggh4x)
library(patchwork)
library(colorblindr)
library(ggbeeswarm)
library(ggpubr)

# library(showtext)

# library(DT)
# library(colorblindr)
# library(ggdendro)
# library(RColorBrewer)
# library(circlize)
# library(Hmisc)
# library(ComplexHeatmap)
# library(ineq)

# library(kableExtra)
# library(magrittr)
# library(ggrepel)
# library(ggpubr)
# library(ggbeeswarm)
# library(ggridges)
```

Load ggplot theme
```{r ggplot-theme}
source("./configuration/rmarkdown/ggplot_theme.R")
```

Load ggplot theme
```{r color-palette}
source("./configuration/rmarkdown/color_palettes.R")
```

Load Summarized Experiment object
```{r load-se}
se <- readRDS(file.path(params$data_dir, 'se.rds'))
```


```{r, eval = FALSE}
x <- colData(se) %>% data.frame
use_samples <- c(
  'dCas4T1Repl1_NSGTum',
  'dCas4T1Repl2_NSGTum',
  'dCas4T1Repl3_NSGTum',
  'dCas4T1Repl4_NSGTum',
  'dCas4T1Repl5_NSGTum',
  'Replacement_5bis',
  'Replacement_6bis',
  'Replacement_7bis',
  'Replacement_8bis',
  'Replacement_9bis'
)

x[use_samples,] %>% select(effect_type_short, effect_type_short,vector_short)

x['dC9BL6_LungIV_C167_1',]
```

Filter samples used for this analysis
```{r dw-sel-cols}
use_cols <- colData(se) %>% 
  data.frame %>% 
  filter(effect_type_short == 'noKO') %>% 
  filter(vector_short != "Thy1_EF1alpha_dCas9") %>% 
  rownames

se <- se[,use_cols]
```

Data wrangling
```{r dw-colData}
chunk_colData <- colData(se) %>% data.frame %>%
  mutate(
    vector_short = ifelse(vector_short == 'Puro_EF1alpha_SpCas9', 
                          'Cas9+Puro', vector_short),
    vector_short = ifelse(vector_short == 'Puro+ dCas9', 
                          'Cas9+Puro', vector_short),
    vector_short = factor(vector_short, levels = c('Thy1', 'Puro', 'Cas9+Puro')),
    mouse_model_short = case_match(mouse_model_global,
                                   'immunodeficient' ~ 'NSG',
                                   'immunocompetent' ~ 'Syngeneic',
                                   'C57BL6' ~ 'Syngeneic'
                                   ),
    mouse_model_short = factor(mouse_model_short, levels = c('NSG', 'Syngeneic')),
    vector_mhost = paste0(vector_short, ', ', mouse_model_short),
    model_vector_mhost = paste0(donor,', ', vector_short, ', ', mouse_model_short),
    sample_type = ifelse(cancer_type %in% c('Breast', 'CRC'),
                         case_match(sample_type, 
                             'whole_tumor' ~ 'Primary tumor', 
                             'whole_lung' ~ 'Lung mets',
                             'bulk' ~ 'Bulk',
                             'cell_culture' ~ 'Cell culture'),
                         sample_type
                         ),
        sample_type = ifelse(cancer_type %in% c('NSCLC'),
                         case_match(sample_type, 
                             'met_liver' ~ 'Liver mets', 
                             'whole_lung' ~ 'Primary tumor',
                             'bulk' ~ 'Bulk',
                             'cell_culture' ~ 'Cell culture'),
                         sample_type
                         ),
    
    sample_type = factor(sample_type, levels = c('Primary tumor', 'Lung mets', 'Liver mets', 'Bulk', 'Cell culture'))
    
  )

colData(se) <- chunk_colData %>% DataFrame


```

## Configure analyses

Define comparisons for modality and Kolmogorov-Smirnov test
```{r define-comparisons-modality-ks}
x <- colData(se) %>% data.frame

group_list_modality <- list(
  `Syngeneic Thy1` = x %>% 
    filter(vector_mmodel == '4T1-noKO-Thy1-BALB' & sample_type == 'Primary tumor') %>% 
    pull(sample_alias),
  
  `Syngeneic Puro` = x %>% 
    filter(vector_mmodel %in% c('4T1-noKO-Puro-BALB', 'MVT1-noKO-Puro-FVB', 'Py2T-noKO-Puro-FVB') & sample_type == 'Primary tumor') %>%
    pull(sample_alias),
  
  `Syngeneic dCas9 + Puro` = x %>% 
    filter(vector_mmodel == '4T1-noKO-Puro_EF1alpha_dCas9-BALB' & sample_type == 'Primary tumor') %>% 
    pull(sample_alias),
  
  `NSG Thy1` =  x %>% 
    filter(vector_mmodel %in% c('4T1-noKO-Thy1-NSG', 'MVT1-noKO-Thy1-NSG', 'Py2T-noKO-Thy1-NSG') & sample_type == 'Primary tumor') %>%
    pull(sample_alias),
  
  `NSG Puro` = x %>% 
    filter(vector_mmodel %in% c('4T1-noKO-Puro-NSG', 'MVT1-noKO-Puro-NSG', 'Py2T-noKO-Puro-NSG') & sample_type == 'Primary tumor') %>%
    pull(sample_alias),
  
  `NSG dCas9 + Puro` = x %>% 
    filter(vector_mmodel == '4T1-noKO-Puro_EF1alpha_dCas9-NSG' & sample_type == 'Primary tumor') %>% 
    pull(sample_alias)
)

comp_list_modality <- list(
  `Syngeneic Thy1 vs. dCas9 + Puro` = list(
    `dCas9 + Puro` = group_list_modality$`Syngeneic dCas9 + Puro`,
    `Thy1` = group_list_modality$`Syngeneic Thy1`
  ),
  `Syngeneic Thy1 vs. Puro` = list(
    `Puro` = group_list_modality$`Syngeneic Puro`,
    `Thy1` = group_list_modality$`Syngeneic Thy1`
  )
)

group_df_modality <- foreach(i = names(group_list_modality), .combine = rbind) %do% {
  data.frame(
    sample_alias = group_list_modality[[i]],
    modality_group = i
  )
}
```


## sgRNA distribution in Primary tumor
```{r test-dist-tumor-conf}
use_sample_type <- 'Primary tumor'
use_colData <- colData(se) %>% data.frame %>%
  filter(sample_type == use_sample_type)
```

### Figure 2B: sgRNA distribution in mice transplanted with 4T1 cells

Density plots showing the distribution of unique sgRNAs retrieved in orthotopic primary tumors from the indicated mice transplanted with 4T1 cells, previously transduced as indicated; frequency is shown as read counts per million (cpm) in log10 scale adding a pseudocunt of 1; Each plot is representative of a group of n=5 mice. 

```{r test-dist-tumor-distribution-ridges_plot-4t1, fig.width=3, fig.asp=1}
selected_panels <- list(
  `Thy1, NSG` = c('4T_TumoT_N4', '4T_TumoT_N5', '4T_TumoT_N2'),
  `Thy1, Syngeneic` = c('4T_TumoT_B1', '4T_TumoT_B3', '4T_TumoT_B4'),
 
  `Puro, NSG` = c('4T_TumoP_N5', '4T_TumoP_N4', '4T_TumoP_N2'),
  `Puro, Syngeneic` = c('4T_TumoP_B3', '4T_TumoP_B2', '4T_TumoP_B1'),
  
  `dCas9+Puro, NSG` = c('PlatePositionE1', 'PlatePositionC1', 'PlatePositionA2'),
  `dCas9+Puro, Syngeneic` = c('PlatePositionE2', 'PlatePositionG2', 'PlatePositionC2')
  
)

selected_panels_df <- foreach(i = names(selected_panels), .combine = rbind) %do% {
  data.frame(group = i, sample_alias = selected_panels[[i]])
}

use_samples <- unlist(selected_panels)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData) %>% 
  left_join(selected_panels_df) %>% 
  mutate(
    sample_alias = factor(sample_alias, levels = use_samples),
    group = factor(group, levels = names(selected_panels))
  )

use_assay %>% 
  ggplot(aes(x=cpm + 1, y = sample_alias, 
             fill = vector_short, color = vector_short, 
             height = after_stat(density))) +
  geom_density_ridges(size = one_pt/4, 
                      alpha = 0.8, 
                      scale = 4,
                      rel_min_height = 0.001 # set the `rel_min_height` argument to remove tails,
                      ) +
  scale_fill_manual(values = palette_vector) +
  scale_color_manual(values = palette_vector_line) +
  scale_x_log10(expand = expansion(mult = c(0, 0))) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none', color = 'none') +
  facet_wrap2(vars(group), ncol = 2,
                     scales = 'free_y',
                     axes = "x") +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.text.y = element_blank(),
    strip.text.x = element_text(size=4, hjust = 0)
  )
                                
```


### Supplementary Figure 2B: sgRNA distribution in mice transplanted with Py2T and MVT1 cells
```{r test-dist-tumor-distribution-ridges_plot-py2t-mvt1, fig.width=3, fig.asp=1.33}
selected_panels <- list(
  `Py2T, Thy1, NSG` = c('PY_TumoT_N5', 'PY_TumoT_N4', 'PY_TumoT_N3'),
  `Py2T, Thy1, Syngeneic` = c('PY_TumoT_F3', 'PY_TumoT_F4', 'PY_TumoT_F5'), 
  
  `Py2T, Puro, NSG` = c('PY_TumoP_N1', 'PY_TumoP_N2', 'PY_TumoP_N3'),
  `Py2T, Puro, Syngeneic` = c('PY_TumoP_F1', 'PY_TumoP_F5', 'PY_TumoP_F2'),
  
  `MVT1, Thy1, NSG` = c('MVT_TumoT_N3', 'MVT_TumoT_N4', 'MVT_TumoT_N5'),
  `MVT1, Thy1, Syngeneic` = c('MVT_TumoT_F1', 'MVT_TumoT_F4', 'MVT_TumoT_F3'),
  
  `MVT1, Puro, NSG` = c('MVT_TumoP_N3', 'MVT_TumoP_N4', 'MVT_TumoP_N5'),
  `MVT1, Puro, Syngeneic` = c('MVT_TumoP_F3', 'MVT_TumoP_F4', 'MVT_TumoP_F5')
)

selected_panels_df <- foreach(i = names(selected_panels), .combine = rbind) %do% {
  data.frame(group = i, sample_alias = selected_panels[[i]])
}

use_samples <- unlist(selected_panels)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData) %>% 
  left_join(selected_panels_df) %>% 
  mutate(
    sample_alias = factor(sample_alias, levels = use_samples),
    group = factor(group, levels = names(selected_panels))
  )

use_assay %>% 
  ggplot(aes(x=cpm + 1, y = sample_alias, 
             fill = vector_short, 
             color = vector_short, 
             height = after_stat(density))) +
  geom_density_ridges(size = one_pt/4, 
                      alpha = 0.8, 
                      scale = 4,
                      rel_min_height = 0.001 # set the `rel_min_height` argument to remove tails,
                      ) +
  scale_fill_manual(values = palette_vector) +
  scale_color_manual(values = palette_vector_line) +
  scale_x_log10(expand = expansion(mult = c(0, 0))) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none', color = 'none') +
  facet_wrap2(vars(group), ncol = 2,
                     scales = 'free_y',
                     axes = "x") +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.text.y = element_blank(),
    panel.border = element_rect(fill =NULL,
                                color = "black",
                                linewidth = 2*one_pt)
  )
                                
```


## Kolmogorov-Smirnov test and ECDF plots 

Run Kolmogorov-Smirnov test to compare distributions merged by group and create Empirical Cumulative Density Function (ECDF) by comparison.
```{r modality-comparisons-ks-ecdf-run}

i <- names(comp_list_modality)[1]
ks_test_df <- data.frame()
ecdf_plots <- list()
for(i in names(comp_list_modality)) {
  use_samples <- comp_list_modality[[i]]
  use_assay_c <- assay(se[,use_samples[[1]]], 'cpm') %>% 
    data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, values_to = 'cpm',names_to = 'sample_alias') %>% 
    mutate(group = 'case', condition = names(use_samples)[1])
  use_assay_r <- assay(se[,use_samples[[2]]], 'cpm') %>% 
    data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, values_to = 'cpm',names_to = 'sample_alias') %>% 
    mutate(group = 'referene', condition = names(use_samples)[2])
  use_assay <- rbind(use_assay_c, use_assay_r)
  
  # Perform the Kolmogorov-Smirnov test
  ks.res <- ks.test(use_assay_c$cpm, use_assay_r$cpm)
  ks_test_df <- rbind(
    ks_test_df,
      data.frame(
        comparison = i,
        case = names(use_samples)[1],
        reference = names(use_samples)[2],
        D = ks.res$statistic,
        P = ks.res$p.value
      )
    )

  # Create ECDFs plot Empirical Cumulative Density Function
  # use_colors <- c('red', 'blue') %>% set_names(names(use_samples))
  ecdf_plots[[i]] <- use_assay %>% 
    ggplot(aes(x = log(1+cpm), color = condition, group = sample_alias)) +
    stat_ecdf(geom = 'step', alpha = 1, linewidth = one_pt/4) +
    scale_color_manual(values = palette_vector) +
    labs(x = "log(1+cpm)",
         color = '',
         sub = i#,
         # caption =paste("Kolmogorov-Smirnov test p-value:", round(ks.res$p.value, 3), "\n",
                        # "Kolmogorov-Smirnov test D:", round(ks.res$statistic, 3))
         ) +
    theme(
      text = element_text(size=2),
      axis.text.y =  element_text(size=3),
      axis.text.x =  element_text(size=3),
      legend.text =  element_text(size=2),
      legend.title =  element_text(size=2),
      plot.subtitle = element_text(size=3),
      plot.caption =  element_text(size=2)
      
    )

}
```

### Supplementary Figure 2C left : K-S test table 
```{r modality-comparisons-ks-table}
ks_test_df %>% 
  dplyr::select(-case, -reference) %>% 
  mutate(P = format.pval(P)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Results of Kolmogorov-Smirnov test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1)
              )
            )
            ) %>% 
    formatRound(columns = c('D'), digits = 3)
```

### Supplementary Figure 2C right : Empirical Cumulative Density Function (ECDF) plots
Empirical Cumulative Density Function (ECDF) plot by comparison
```{r modality-comparisons-ks-ecdf, fig.width = 3, fig.asp = 0.3}
# Dim for an individual plot : fig.width = 1.5, fig.asp = 0.66
# for(i in names(ecdf_plots)) {
#   cat("#####", i, "\n")
#   print(ecdf_plots[[i]])
#   cat("\n\n")
# }
use_index <- c("Syngeneic Thy1 vs. Puro", "Syngeneic Thy1 vs. dCas9 + Puro")
plot_grid(plotlist = ecdf_plots[use_index], ncol = 2)
```

## Hartigans' dip test
Hartigans' dip test for unimodality. If the p-value is less than 0.05, there's enough evidence to claim that the data are not unimodal (multimodal, at least bimodal).

```{r test-dip}
use_assay <- assay(se, 'cpm')
i <- colnames(use_assay)[1]
modality_test_df <- foreach(i= colnames(use_assay), .combine = rbind) %do%{
  x <- use_assay[,i]
  dip.res <- dip.test(x, simulate.p.value = FALSE, B = 2000)
  data.frame(
    sample_alias = i,
    dip.D = dip.res$statistic,
    dip.p = dip.res$p.value,
    dip.result = ifelse(dip.res$p.value < 0.05, 'multimodal', 'unimodal')
    )
}

modality_test_df %<>% 
  left_join(group_df_modality) %>% 
  left_join(colData(se) %>% data.frame)
  
```

### Supplementary Figure 2D left: Dip test table for Syngeneic models
```{r test-dip-syngeneic-table}
modality_test_df %>% 
  filter(!is.na(modality_group)) %>% 
  filter(mouse_model_global == 'immunocompetent') %>% 
  mutate(
    modality_group = factor(modality_group, levels = names(group_list_modality))
  ) %>%
  group_by(modality_group) %>%
  summarise(
    `Median D` = median(dip.D) %>% round(3),
    n = n(),
    `Multimodal samples (n)` = sum(dip.result == 'multimodal'),
    `Unimodal samples (n)` = sum(dip.result == 'unimodal'),
    `Multimodal samples (%)` = round(100*`Multimodal samples (n)`/n, 1),
    `Unimodal samples (%)` = round(100*`Unimodal samples (n)`/n, 1)
  ) %>% 
  data.frame(check.names = F) %>% 
  kbl(caption = 'Dip test results for Syngeneic models') %>%
  kable_paper(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

### Supplementary Figure 2D right: Dip test table for NSG models
```{r test-dip-nsg-table}
modality_test_df %>% 
  filter(!is.na(modality_group)) %>% 
  filter(mouse_model_global == 'immunodeficient') %>% 
  mutate(
    modality_group = factor(modality_group, levels = names(group_list_modality))
  ) %>%
  group_by(modality_group) %>%
  summarise(
    `Median D` = median(dip.D) %>% round(3),
    n = n(),
    `Multimodal samples (n)` = sum(dip.result == 'multimodal'),
    `Unimodal samples (n)` = sum(dip.result == 'unimodal'),
    `Multimodal samples (%)` = round(100*`Multimodal samples (n)`/n, 1),
    `Unimodal samples (%)` = round(100*`Unimodal samples (n)`/n, 1)
  ) %>% 
  data.frame(check.names = F) %>% 
  kbl(caption = 'Dip test results for NSG models') %>%
  kable_paper(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```









## Muller plots

Define selected comparisons for muller plots
```{r define-comparisons-muller-plots}
comp_list_muller_syngeneic_representative <- list(
 `Thy1` = c('4T_TumoT_B3', '4T_LungsT_B3'),
 `Puro` = c('4T_TumoP_B1', '4T_LungsP_B1'),
 `dCas9 + Puro` = c('PlatePositionA3', 'PlatePositionB3')
)
```

Generate muller plots
```{r run-muller-syngeneic-representative-plots}
cpm_threshold <- 10000
comp_list <- comp_list_muller_syngeneic_representative

use_df <- assay(se, 'cpm') %>% data.frame(check.names = FALSE) %>% 
  rownames_to_column('guide') %>% 
  mutate(
    gene = rowData(se)$Gene,
    gene = ifelse(grepl('Non_Target', gene), 'Non_Target', gene)
  ) %>%
  pivot_longer(-c(guide, gene), names_to = 'sample_alias', values_to = 'cpm')

j <-  names(comp_list)[1]
muller_plots <- foreach(j = names(comp_list)) %do% {
  i <- comp_list[[j]]
  x <- use_df %>% 
    filter(sample_alias %in% i) %>% 
    mutate(
      sample_type = ifelse(sample_alias == i[1], 'Primary tumor', 'Lungs'),
      sample_type = factor(sample_type, levels = c('Primary tumor', 'Lungs'))
    )
  
  # Select guides with cpm > cpm_threshold
  x_guides_keep <- x %>% 
    group_by(sample_type, guide) %>% 
    summarise(cpm = max(cpm)) %>% 
    filter(cpm > cpm_threshold) %>% 
    pull(guide)
  
  # Group guides with cpm < cpm_threshold into the low abundant category, and sum counts for low abundant
  x %<>% 
    mutate(
      guide = ifelse(guide %in%  x_guides_keep, guide, 'low abundant')
    ) %>% 
    group_by(sample_type, guide) %>%
    summarise(cpm = sum(cpm)) %>% 
    ungroup() %>%
    mutate(
      guide = fct_reorder(guide, cpm),
      guide = relevel(guide, ref = 'low abundant')
    )
  
  use_cols <- c(
    'low abundant' = 'grey80',
    colorRampPalette(rev(palette_OkabeIto))(nlevels(x$guide) - 1) %>% set_names(levels(x$guide)[-1])
  )
  
  x %>% 
    ggplot( aes(x = sample_type, y = cpm/10000, group = guide, fill = guide)) + 
    geom_area(colour = alpha("white", 0.1), linewidth = 0.08, alpha = 0.8) +
    scale_fill_manual(values = use_cols, guide = guide_legend(ncol = 3)) +
    labs(
      x = '',
      y = expression("CPM x 10"^-4),
      title = j,
      fill = ''
    ) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 1000000/10000)) +
    guides(fill = FALSE) +
    theme(
      panel.background = element_rect(fill = "grey90"),
      # plot.margin = margin(0.5, 1.5, 0.5, 0, "cm"),
      plot.margin = margin(0, 0.5, 0, 0, "cm"),
      axis.text =  element_text(size=3),
      axis.title =  element_text(size=3),
      plot.title = element_text(size=3, hjust = 0.5)
    )

}
names(muller_plots) <- names(comp_list)
muller_syngeneic_representative <- muller_plots
```

### Figure 2C: Representative MÃ¼ller plots of 4T1 in syngeneic recipients

```{r muller-syngeneic-representative-plots, fig.width = 1.5, fig.asp = 2}
wrap_plots(muller_plots, ncol = 1)
```


## Complexity dynamics

### Figure 2D: Complexity dynamics in primary tumors and lung metastases
```{r complexity-dynamics}
se <- readRDS(file.path(params$data_dir, 'se.rds'))

# Define groups of samples
data_array <- c(
  "Thy1","4T_TumoT_N4","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N2","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N5","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N3","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N1","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N5","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N4","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N1","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N2","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N3","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N2","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N5","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N4","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N3","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N1","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N1","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N2","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N5","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N4","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N3","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N5","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N2","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N3","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N4","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N1","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N1","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N4","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N5","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N2","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N3","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionC1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionA2","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionE1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionG1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionA1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl1_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl2_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl3_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl4_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl5_NSGTum","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_LungsT_N3","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N4","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N5","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N1","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N2","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N4","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N2","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N3","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N1","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N5","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N2","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N5","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N4","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N3","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N4","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N5","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N3","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N2","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N2","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N5","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N3","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N4","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N5","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N4","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N3","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N2","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionB1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionD1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionB2","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionF1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionH1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_5bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_6bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_7bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_8bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_9bis","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_TumoT_B5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","sample_5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","PY_TumoP_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","PY_TumoP_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","PY_TumoP_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionC2","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionG2","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionA3","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionC3","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionE2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_LungsT_B2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionD3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionB3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionH2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionF2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionD2","Syngeneic Lung mets","Syngeneic","Lung mets"
)


use_sample_groups <- matrix(data_array, ncol = 5, byrow = TRUE, 
       dimnames = list(c(), c('vector_short', 'sample_alias', 'model_sample_type', 'mouse_model_short', 'sample_type'))) %>% 
  data.frame %>% 
  unique



chunk_data <- colData(se) %>% data.frame %>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215
  ) %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  dplyr::select(sample_alias, starts_with('guides_over')) %>% 
  left_join(use_sample_groups) %>% 
  mutate(
    model_sample_type = factor(model_sample_type, levels = c('NSG', 'Syngeneic')),
    vector_short = factor(vector_short, levels = c('Thy1', 'Puro', 'dCas9+Puro'))
  )
 


# # Exclude samples because PCR amplification problems, these samples showed unconvincing bands
# use_samples <- c(
#   'dCas4T1Repl1_NSGTum',
#   'dCas4T1Repl2_NSGTum',
#   'dCas4T1Repl3_NSGTum',
#   'dCas4T1Repl4_NSGTum',
#   'Replacement_5bis',
#   'Replacement_7bis',
#   'Replacement_8bis',
#   'Replacement_9bis'
# )

# chunk_data %<>% filter(!sample_alias %in% use_samples)
# 
use_comparisons <- list(
  c("Thy1", "Puro"),
  c("Puro", "dCas9+Puro"),
  c("Thy1", "dCas9+Puro")
)
```

#### Source data
```{r complexity-dynamics-data}
chunk_data %>% 
  dplyr::select(sample_alias, vector_short, mouse_model_short, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```


#### Threshold 30x
```{r complexity-dynamics-30x, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_30_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all"
              # scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  stat_compare_means(
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )
```

Same plot, with P.adjust at panel level
```{r complexity-dynamics-30x-padj-panel, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_30_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

Same plot, with P.adjust at group level
```{r complexity-dynamics-30x-padj-group, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_30_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "group",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```


#### Threshold 100x
```{r complexity-dynamics-100x, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_100_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  stat_compare_means(
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

Same plot, with P.adjust at panel level
```{r complexity-dynamics-100x-padj-panel, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_100_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

Same plot, with P.adjust at group level
```{r complexity-dynamics-100x-padj-group, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_100_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "group",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```


### Figure 2D: Second-draft - Complexity dynamics in primary tumors and lung metastases
```{r complexity-dynamics-v2}
se <- readRDS(file.path(params$data_dir, 'se.rds'))

# Define groups of samples
data_array <- c(
  "Thy1","4T_TumoT_N4","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N2","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N5","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N3","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_TumoT_N1","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N5","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N4","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N1","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N2","NSG tumor","NSG","Primary tumor",
  "Thy1","MVT_TumoT_N3","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N2","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N5","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N4","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N3","NSG tumor","NSG","Primary tumor",
  "Thy1","PY_TumoT_N1","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N1","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N2","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N5","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N4","NSG tumor","NSG","Primary tumor",
  "Puro","4T_TumoP_N3","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N5","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N2","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N3","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N4","NSG tumor","NSG","Primary tumor",
  "Puro","MVT_TumoP_N1","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N1","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N4","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N5","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N2","NSG tumor","NSG","Primary tumor",
  "Puro","PY_TumoP_N3","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionC1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionA2","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionE1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionG1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","PlatePositionA1","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl1_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl2_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl3_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl4_NSGTum","NSG tumor","NSG","Primary tumor",
  "dCas9+Puro","dCas4T1Repl5_NSGTum","NSG tumor","NSG","Primary tumor",
  "Thy1","4T_LungsT_N3","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N4","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N5","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N1","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_LungsT_N2","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N4","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N2","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N3","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N1","NSG Lung mets","NSG","Lung mets",
  "Thy1","MVT_LungsT_N5","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N2","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N5","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N4","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N3","NSG Lung mets","NSG","Lung mets",
  "Thy1","PY_LungsT_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N4","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N5","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N3","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N2","NSG Lung mets","NSG","Lung mets",
  "Puro","4T_LungsP_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N2","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N5","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N3","NSG Lung mets","NSG","Lung mets",
  "Puro","MVT_LungsP_N4","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N5","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N4","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N3","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N1","NSG Lung mets","NSG","Lung mets",
  "Puro","PY_LungsP_N2","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionB1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionD1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionB2","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionF1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","PlatePositionH1","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_5bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_6bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_7bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_8bis","NSG Lung mets","NSG","Lung mets",
  "dCas9+Puro","Replacement_9bis","NSG Lung mets","NSG","Lung mets",
  "Thy1","4T_TumoT_B5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_TumoT_B2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","MVT_TumoT_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","PY_TumoT_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","4T_TumoP_B4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","sample_5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F3","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F4","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","MVT_LungsT_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","PY_TumoP_F2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","PY_TumoP_F5","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","PY_TumoP_F1","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","","Syngeneic tumor","Syngeneic","Primary tumor",
  "Puro","","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionC2","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionG2","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionA3","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionC3","Syngeneic tumor","Syngeneic","Primary tumor",
  "dCas9+Puro","PlatePositionE2","Syngeneic tumor","Syngeneic","Primary tumor",
  "Thy1","4T_LungsT_B2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","4T_LungsT_B5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","MVT_LungsT_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Thy1","PY_LungsT_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","4T_LungsP_B4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","MVT_LungsP_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F1","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F4","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F5","Syngeneic Lung mets","Syngeneic","Lung mets",
  "Puro","PY_LungsP_F2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionD3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionB3","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionH2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionF2","Syngeneic Lung mets","Syngeneic","Lung mets",
  "dCas9+Puro","PlatePositionD2","Syngeneic Lung mets","Syngeneic","Lung mets"
)


use_sample_groups <- matrix(data_array, ncol = 5, byrow = TRUE, 
       dimnames = list(c(), c('vector_short', 'sample_alias', 'model_sample_type', 'mouse_model_short', 'sample_type'))) %>% 
  data.frame %>% 
  unique



chunk_data <- colData(se) %>% data.frame %>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215
  ) %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  dplyr::select(sample_alias, starts_with('guides_over')) %>% 
  left_join(use_sample_groups) %>% 
  mutate(
    model_sample_type = factor(model_sample_type, levels = c('NSG', 'Syngeneic')),
    vector_short = factor(vector_short, levels = c('Thy1', 'Puro', 'dCas9+Puro'))
  )
 


# Exclude samples because PCR amplification problems, these samples showed unconvincing bands
use_samples <- c(
  'dCas4T1Repl1_NSGTum',
  'dCas4T1Repl2_NSGTum',
  'dCas4T1Repl3_NSGTum',
  'dCas4T1Repl4_NSGTum',
  'Replacement_5bis',
  'Replacement_7bis',
  'Replacement_8bis',
  'Replacement_9bis'
)

chunk_data %<>% filter(!sample_alias %in% use_samples)

# Define comparisons
use_comparisons <- list(
  c("Thy1", "Puro"),
  c("Puro", "dCas9+Puro"),
  c("Thy1", "dCas9+Puro")
)
```

#### Source data
```{r complexity-dynamics-v2-data}
chunk_data %>% 
  dplyr::select(sample_alias, vector_short, mouse_model_short, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```


#### Threshold 30x
```{r complexity-dynamics-v2-30x, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_30_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all"
              # scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  stat_compare_means(
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )
```

Same plot, with P.adjust at panel level
```{r complexity-dynamics-v2-30x-padj-panel, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_30_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

Same plot, with P.adjust at group level
```{r complexity-dynamics-v2-30x-padj-group, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_30_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "group",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```


#### Threshold 100x
```{r complexity-dynamics-v2-100x, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_100_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  stat_compare_means(
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

Same plot, with P.adjust at panel level
```{r complexity-dynamics-v2-100x-padj-panel, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_100_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

Same plot, with P.adjust at group level
```{r complexity-dynamics-v2-100x-padj-group, fig.asp = 1.8, fig.width = 2}
chunk_data %>% 
  ggplot(aes(vector_short, guides_over_100_pct,
             color = vector_short,
             fill = vector_short)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = palette_vector) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  facet_grid2(sample_type ~ mouse_model_short,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test", 
    label = "p.adj.format",
    p.adjust.method = "holm", 
    p.adjust.by = "group",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```




### Figure 3H: First draft
```{r complexity-dynamics-3d-conf}
se <- readRDS(file.path(params$data_dir, 'se.rds'))

# Define groups of samples
data_array <- c(
  "No Cas9","CRISPRKO_Clone_61","In vitro",
  "No Cas9","CRISPRKO_Clone_64","In vitro",
  "No Cas9","CRISPRKO_Clone_67","In vitro",
  "No Cas9","C167_Thy1_baseline","In vitro",
  "No Cas9","LLC1_Thy1_baseline","In vitro",
  "+Apo-Cas9","CRISPRKO_Clone_60","In vitro",
  "+Apo-Cas9","CRISPRKO_Clone_65","In vitro",
  "+Apo-Cas9","CRISPRKO_Clone_68","In vitro",
  "+Apo-Cas9","C167_StealTHY","In vitro",
  "+Apo-Cas9","LLC1_StealTHY","In vitro",
  "+Apo-Cas9","CT26_StealTHY","In vitro",
  "Stable dCas9","C167_dCas9baseline","In vitro",
  "Stable dCas9","LLC1_dCas9baseline","In vitro",
  "Stable dCas9","MVT1_dCas9baseline","In vitro",
  "Stable dCas9","Py2T_dCas9baseline","In vitro",
  "Stable dCas9","4T1_dCas9baseline","In vitro",
  "+LV Cas9","CRISPRKO_Clone_62","In vitro",
  "+LV Cas9","CRISPRKO_Clone_66","In vitro",
  "+LV Cas9","CRISPRKO_Clone_69","In vitro",
  "+LV Cas9","PlatePositionC11","In vitro",
  "+LV Cas9","PlatePositionH10","In vitro",
  "+LV Cas9","PlatePositionB11","In vitro",
  "No Cas9","4T_TumoT_B5","In vivo (mammary fat pad)",
  "No Cas9","4T_TumoT_B3","In vivo (mammary fat pad)",
  "No Cas9","4T_TumoT_B1","In vivo (mammary fat pad)",
  "No Cas9","MVT_TumoT_F1","In vivo (mammary fat pad)",
  "No Cas9","MVT_TumoT_F3","In vivo (mammary fat pad)",
  "No Cas9","MVT_TumoT_F4","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_13","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_14","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_11","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_22","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_24","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_20","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionG2","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionA3","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionC3","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionE2","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionC2","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionA6","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionE5","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionC5","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionA5","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionG4","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionG6","In vivo (mammary fat pad)",
  "No Cas9","Replacement_9","In vivo (lung intravenous)",
  "No Cas9","Replacement_5","In vivo (lung intravenous)",
  "No Cas9","Replacement_2bis","In vivo (lung intravenous)",
  "No Cas9","Replacement_7","In vivo (lung intravenous)",
  "+Apo-Cas9","LLC1_StealTHY_Tum_3","In vivo (lung intravenous)",
  "+Apo-Cas9","LLC1_StealTHY_Tum_5","In vivo (lung intravenous)",
  "+Apo-Cas9","C167_StealTHY_Tum_3","In vivo (lung intravenous)",
  "+Apo-Cas9","C167_StealTHY_Tum_5","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_LLC1_1","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_LLC1_2","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_C167_2","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_C167_4","In vivo (lung intravenous)",
  "+Apo-Cas9","ColoCT26_StealTHY_Tum_2","In vivo (colon cecal wall)",
  "+Apo-Cas9","ColoCT26_StealTHY_Tum_3","In vivo (colon cecal wall)",
  "+Apo-Cas9","Replacement_2","In vivo (colon cecal wall)",
  "+Apo-Cas9","Replacement_4","In vivo (colon cecal wall)"
)
# 
# data_array <- c(
#   "No Cas9","CRISPRKO_Clone_61","In vitro",
#   "No Cas9","CRISPRKO_Clone_64","In vitro",
#   "No Cas9","CRISPRKO_Clone_67","In vitro",
#   "No Cas9","C167_Thy1_baseline","In vitro",
#   "No Cas9","LLC1_Thy1_baseline","In vitro",
#   "+Apo-Cas9","PlatePositionG10","In vitro",
#   "+Apo-Cas9","CRISPRKO_Clone_65","In vitro",
#   "+Apo-Cas9","CRISPRKO_Clone_68","In vitro",
#   "+Apo-Cas9","C167_StealTHY","In vitro",
#   "+Apo-Cas9","LLC1_StealTHY","In vitro",
#   "+Apo-Cas9","CT26_StealTHY","In vitro",
#   "+LV Cas9","CRISPRKO_Clone_62","In vitro",
#   "+LV Cas9","CRISPRKO_Clone_66","In vitro",
#   "+LV Cas9","CRISPRKO_Clone_69","In vitro",
#   "+LV Cas9","PlatePositionC11","In vitro",
#   "+LV Cas9","PlatePositionH10","In vitro",
#   "+LV Cas9","PlatePositionB11","In vitro",
#   "Stable dCas9","C167_dCas9baseline","In vitro",
#   "Stable dCas9","LLC1_dCas9baseline","In vitro",
#   "Stable dCas9","MVT1_dCas9baseline","In vitro",
#   "Stable dCas9","Py2T_dCas9baseline","In vitro",
#   "Stable dCas9","4T1_dCas9baseline","In vitro",
#   "No Cas9","4T_TumoT_B5","In vivo",
#   "No Cas9","4T_TumoT_B3","In vivo",
#   "No Cas9","MVT_TumoT_F3","In vivo",
#   "No Cas9","MVT_TumoT_F5","In vivo",
#   "No Cas9","Replacement_9","In vivo",
#   "No Cas9","Replacement_5","In vivo",
#   "+Apo-Cas9","CRISPRKO_Clone_13","In vivo",
#   "+Apo-Cas9","CRISPRKO_Clone_22","In vivo",
#   "+Apo-Cas9","CRISPRKO_Clone_24","In vivo",
#   "+Apo-Cas9","C167_StealTHY_Tum_1","In vivo",
#   "+Apo-Cas9","LLC1_StealTHY_Tum_1","In vivo",
#   "+Apo-Cas9","ColoCT26_StealTHY_Tum_1","In vivo",
#   "+LV Cas9","PlatePositionA6","In vivo",
#   "+LV Cas9","PlatePositionE5","In vivo",
#   "+LV Cas9","PlatePositionC5","In vivo",
#   "+LV Cas9","PlatePositionA5","In vivo",
#   "+LV Cas9","PlatePositionG4","In vivo",
#   "+LV Cas9","PlatePositionG6","In vivo",
#   "Stable dCas9","PlatePositionG2","In vivo",
#   "Stable dCas9","PlatePositionA3","In vivo",
#   "Stable dCas9","PlatePositionC3","In vivo",
#   "Stable dCas9","PlatePositionE2","In vivo",
#   "Stable dCas9","PlatePositionC2","In vivo",
#   # Previous samples
#   "No Cas9","CRISPRKO_Clone_61","In vitro",
#   "No Cas9","CRISPRKO_Clone_64","In vitro",
#   "No Cas9","CRISPRKO_Clone_67","In vitro",
#   "No Cas9","CRISPRKO_Clone_63","In vitro",
#   "No Cas9","CRISPRKO_Clone_71","In vitro",
#   "No Cas9","CRISPRKO_Clone_70","In vitro",
#   "+Apo-Cas9","PlatePositionG10","In vitro",
#   "+Apo-Cas9","CRISPRKO_Clone_65","In vitro",
#   "+Apo-Cas9","CRISPRKO_Clone_68","In vitro",
#   "+Apo-Cas9","CRISPRKO_Clone_60","In vitro",
#   "+Apo-Cas9","not found (?)","In vitro",
#   "+Apo-Cas9","not found (?)","In vitro",
#   "+LV Cas9","CRISPRKO_Clone_62","In vitro",
#   "+LV Cas9","CRISPRKO_Clone_66","In vitro",
#   "+LV Cas9","CRISPRKO_Clone_69","In vitro",
#   "+LV Cas9","PlatePositionC11","In vitro",
#   "+LV Cas9","PlatePositionH10","In vitro",
#   "+LV Cas9","PlatePositionB11","In vitro",
#   "No Cas9","4T_TumoT_B5","In vivo",
#   "No Cas9","4T_TumoT_B3","In vivo",
#   "No Cas9","MVT_TumoT_F3","In vivo",
#   "No Cas9","MVT_TumoT_F5","In vivo",
#   "No Cas9","not found (?)","In vivo",
#   "No Cas9","not found (?)","In vivo",
#   "+Apo-Cas9","CRISPRKO_Clone_22","In vivo",
#   "+Apo-Cas9","CRISPRKO_Clone_24","In vivo",
#   "+Apo-Cas9","not found (?)","In vivo",
#   "+Apo-Cas9","not found (?)","In vivo",
#   "+Apo-Cas9","not found (?)","In vivo",
#   "+Apo-Cas9","not found (?)","In vivo",
#   "+LV Cas9","PlatePositionA6","In vivo",
#   "+LV Cas9","PlatePositionE5","In vivo",
#   "+LV Cas9","PlatePositionC5","In vivo",
#   "+LV Cas9","PlatePositionA5","In vivo",
#   "+LV Cas9","PlatePositionG4","In vivo",
#   "+LV Cas9","not found (?)","In vivo"
# )

use_sample_groups <- matrix(data_array, ncol =3, byrow = TRUE, 
       dimnames = list(c(), c('group', 'sample_alias', 'model'))) %>% 
  data.frame %>% 
  mutate(model = ifelse(grepl('In vivo', model), 'In vivo', model)) %>%
  unique

# use_sample_groups$sample_alias[!use_sample_groups$sample_alias %in% colnames(se)]

use_palette <- c(
  `No Cas9` = '#9f71ce',
  `+Apo-Cas9`  = '#F7EC13',
  `+LV Cas9`  = 'black',
  `Stable dCas9` = 'white'
)

chunk_data <- colData(se) %>% data.frame %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  left_join(use_sample_groups)%>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215,
    group = factor(group, levels = c('No Cas9', '+Apo-Cas9', '+LV Cas9', 'Stable dCas9'))
  )


```

#### Source data
```{r complexity-dynamics-3d-data}
chunk_data %>% 
  dplyr::select(sample_alias, model, group, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```

#### Figures
```{r complexity-dynamics-3d, fig.asp = 1.8, fig.width = 1.5}

use_comparisons <- chunk_data$group %>% levels() %>% combn(2,simplify = FALSE)


chunk_data %>% 
  ggplot(aes(group, guides_over_1_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    breaks = c(0, 0.5, 0.75, 1)
    # limits = c(0, 1.2)
    ) +
  facet_grid2(model ~ .,
              axes = "all"
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 1x',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )



chunk_data %>% 
  ggplot(aes(group, guides_over_30_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    breaks = c(0, 0.5, 0.75, 1)
    # limits = c(0, 1.2)
    ) +
  facet_grid2(model ~ .,
              axes = "all"
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 30x',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )


chunk_data %>% 
  ggplot(aes(group, guides_over_100_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    breaks = c(0, 0.5, 0.75, 1)
    # limits = c(0, 1.2)
    ) +
  facet_grid2(model ~ .,
              axes = "all"
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 100x',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )
```


### Figure 3H: Second draft
```{r complexity-dynamics-3d-v2-conf}
se <- readRDS(file.path(params$data_dir, 'se.rds'))


# Define groups of samples
data_array <- c(
  "No Cas9","CRISPRKO_Clone_61","In vitro",
  "No Cas9","CRISPRKO_Clone_64","In vitro",
  "No Cas9","CRISPRKO_Clone_67","In vitro",
  "No Cas9","C167_Thy1_baseline","In vitro",
  "No Cas9","LLC1_Thy1_baseline","In vitro",
  "+Apo-Cas9","CRISPRKO_Clone_60","In vitro",
  "+Apo-Cas9","CRISPRKO_Clone_65","In vitro",
  "+Apo-Cas9","CRISPRKO_Clone_68","In vitro",
  "+Apo-Cas9","C167_StealTHY","In vitro",
  "+Apo-Cas9","LLC1_StealTHY","In vitro",
  "+Apo-Cas9","CT26_StealTHY","In vitro",
  "Stable dCas9","C167_dCas9baseline","In vitro",
  "Stable dCas9","LLC1_dCas9baseline","In vitro",
  "Stable dCas9","MVT1_dCas9baseline","In vitro",
  "Stable dCas9","Py2T_dCas9baseline","In vitro",
  "Stable dCas9","4T1_dCas9baseline","In vitro",
  "+LV Cas9","CRISPRKO_Clone_62","In vitro",
  "+LV Cas9","CRISPRKO_Clone_66","In vitro",
  "+LV Cas9","CRISPRKO_Clone_69","In vitro",
  "+LV Cas9","PlatePositionC11","In vitro",
  "+LV Cas9","PlatePositionH10","In vitro",
  "+LV Cas9","PlatePositionB11","In vitro",
  "No Cas9","4T_TumoT_B5","In vivo (mammary fat pad)",
  "No Cas9","4T_TumoT_B3","In vivo (mammary fat pad)",
  "No Cas9","4T_TumoT_B1","In vivo (mammary fat pad)",
  "No Cas9","MVT_TumoT_F1","In vivo (mammary fat pad)",
  "No Cas9","MVT_TumoT_F3","In vivo (mammary fat pad)",
  "No Cas9","MVT_TumoT_F4","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_13","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_14","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_11","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_22","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_24","In vivo (mammary fat pad)",
  "+Apo-Cas9","CRISPRKO_Clone_20","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionG2","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionA3","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionC3","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionE2","In vivo (mammary fat pad)",
  "Stable dCas9","PlatePositionC2","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionA6","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionE5","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionC5","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionA5","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionG4","In vivo (mammary fat pad)",
  "+LV Cas9","PlatePositionG6","In vivo (mammary fat pad)",
  "No Cas9","Replacement_9","In vivo (lung intravenous)",
  "No Cas9","Replacement_5","In vivo (lung intravenous)",
  "No Cas9","Replacement_2bis","In vivo (lung intravenous)",
  "No Cas9","Replacement_7","In vivo (lung intravenous)",
  "+Apo-Cas9","LLC1_StealTHY_Tum_3","In vivo (lung intravenous)",
  "+Apo-Cas9","LLC1_StealTHY_Tum_5","In vivo (lung intravenous)",
  "+Apo-Cas9","C167_StealTHY_Tum_3","In vivo (lung intravenous)",
  "+Apo-Cas9","C167_StealTHY_Tum_5","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_LLC1_1","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_LLC1_2","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_C167_2","In vivo (lung intravenous)",
  "Stable dCas9","dC9BL6_LungIV_C167_4","In vivo (lung intravenous)",
  "+Apo-Cas9","ColoCT26_StealTHY_Tum_2","In vivo (colon cecal wall)",
  "+Apo-Cas9","ColoCT26_StealTHY_Tum_3","In vivo (colon cecal wall)",
  "+Apo-Cas9","Replacement_2","In vivo (colon cecal wall)",
  "+Apo-Cas9","Replacement_4","In vivo (colon cecal wall)"
)

use_sample_groups <- matrix(data_array, ncol =3, byrow = TRUE, 
       dimnames = list(c(), c('group', 'sample_alias', 'model'))) %>% 
  data.frame %>% 
  unique

# use_sample_groups$sample_alias[!use_sample_groups$sample_alias %in% colnames(se)]

use_palette <- c(
  `No Cas9` = '#9f71ce',
  `+Apo-Cas9`  = '#F7EC13',
  `+LV Cas9`  = 'black',
  `Stable dCas9` = 'white'
)

chunk_data <- colData(se) %>% data.frame %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  left_join(use_sample_groups)%>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215,
    group = factor(group, levels = c('No Cas9', '+Apo-Cas9', '+LV Cas9', 'Stable dCas9'))
  )

use_comparisons <- chunk_data$group %>% levels() %>% combn(2,simplify = FALSE)

# Remove In vivo (colon cecal wall), only one sample
# chunk_data <- chunk_data %>% 
#   filter(model != 'In vivo (colon cecal wall)') %>% 
#   mutate(model = factor(model, levels = c(
#     'In vitro',
#     'In vivo (mammary fat pad)', 
#     'In vivo (lung intravenous)'
#   )))

chunk_data <- chunk_data %>% 
  mutate(model = factor(model, levels = c(
    'In vitro',
    'In vivo (mammary fat pad)', 
    'In vivo (lung intravenous)',
    'In vivo (colon cecal wall)'
  )))
```

#### Source data
```{r complexity-dynamics-3d-v2-data}
chunk_data %>% 
  dplyr::select(sample_alias, model, group, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```

#### Treshold 30x
```{r complexity-dynamics-3d-v2-30x, fig.asp = 4, fig.width = 1.6}
chunk_data %>% 
  ggplot(aes(group, guides_over_30_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    breaks = c(0, 0.5, 0.75, 1)
    # limits = c(0, 1.2)
    ) +
  facet_grid2(
    model ~ .,
    axes = "all"
  ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 30x',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test",
    # label = "p.adj.format",
    # p.adjust.method = "holm",
    # p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  # stat_compare_means(
  #   comparisons = use_comparisons,
  #   method = 'wilcox.test',
  #   size = 0.4*geom_text_size,
  #   bracket.size = one_pt/4
  # ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

#### Treshold 100x
```{r complexity-dynamics-3d-v2-100x, fig.asp = 4, fig.width = 1.6}
chunk_data %>% 
  ggplot(aes(group, guides_over_100_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    breaks = c(0, 0.5, 0.75, 1)
    # limits = c(0, 1.2)
    ) +
  facet_grid2(
    model ~ .,
    axes = "all"
  ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 100x',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test",
    # label = "p.adj.format",
    # p.adjust.method = "holm",
    # p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  # stat_compare_means(
  #   comparisons = use_comparisons,
  #   method = 'wilcox.test',
  #   size = 0.4*geom_text_size,
  #   bracket.size = one_pt/4
  # ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )
```


### Figure 2J-Second draft: T-cell depletion treatment on lung metastasis
```{r complexity-dynamics-2j-conf}
se <- readRDS(file.path(params$data_dir, 'se.rds'))

# Define groups of samples
data_array <- c(
  "PlatePositionB10","11.78","Neg","Ig control",
  "PlatePositionF10","16.88","Neg","Ig control",
  "PlatePositionD10","11.12","Neg","Ig control",
  "CD4_repeat_2","15.1","Neg","Ig control",
  "CD4_repeat_3","8.6","Neg","Ig control",
  # "UntreatRepl1","41.15","Pos","Ig control",
  # "UntreatRepl2","49.44","Pos","Ig control",
  "UntreatRepl3","19.65","Neg","Ig control",
  "UntreatRepl4","22.14","Neg","Ig control",
  "UntreatRepl5","20.77","Not ascertained","Ig control",
  "PlatePositionE10","67.80","Pos","anti-CD4/CD8",
  "PlatePositionC10","45.40","Pos","anti-CD4/CD8",
  # "CD4_repeat_1","53.78","Unclear","anti-CD4/CD8",
  "RescueRepl1","77.92","Pos","anti-CD4/CD8",
  "RescueRepl2","52.16","Not ascertained","anti-CD4/CD8",
  "RescueRepl3","40.93","Pos","anti-CD4/CD8",
  "RescueRepl4","57.11","Pos","anti-CD4/CD8",
  "RescueRepl5","12.49","Not ascertained","anti-CD4/CD8",
  "4T_LungsT_B1","75.35","Not applicable ","untreated",
  "4T_LungsT_B2","66.78","Not applicable","untreated",
  "4T_LungsT_B3","67.89","Not applicable","untreated",
  "4T_LungsT_B4","74.56","Not applicable","untreated",
  "4T_LungsT_B5","65.77","Not applicable","untreated"
)

use_sample_groups <- matrix(data_array, ncol =4, byrow = TRUE, 
       dimnames = list(c(), c('sample_alias', 'Thy1 B+ cells per mm3 of PT', 'Cas9 staining', 'group'))) %>% 
  data.frame(check.names = FALSE) %>% 
  mutate(`Thy1 B+ cells per mm3 of PT` = as.numeric(`Thy1 B+ cells per mm3 of PT`))
  unique

# use_sample_groups$sample_alias[!use_sample_groups$sample_alias %in% colnames(se)]

use_palette <- c(
  `anti-CD4/CD8` = "#0600fe",
  `Ig control`  = "#cccdcd",
  `untreated`  = "#fffe06"
)

```


```{r complexity-dynamics-2j}
chunk_data <- colData(se) %>% data.frame %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  left_join(use_sample_groups)%>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215,
    group = factor(group, levels = c('anti-CD4/CD8', 'Ig control', 'untreated'))
  )

use_comparisons <- chunk_data$group %>% levels() %>% combn(2,simplify = FALSE)
```

#### Source data
```{r complexity-dynamics-2j-data}
chunk_data %>% 
  dplyr::select(sample_alias, `Thy1 B+ cells per mm3 of PT`, `Cas9 staining`, group, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```

#### Treshold 30x

##### Main figure
```{r complexity-dynamics-2j-30x, fig.width = 2, fig.asp = 1}
chunk_data %>% 
  ggplot(aes(`Thy1 B+ cells per mm3 of PT`, guides_over_30_pct,
             color = group,
             fill = group)) +
  geom_point(shape = 21, 
             alpha = 0.8,
             color = 'black',
             size = 1,
             stroke=one_pt/4) +
  scale_fill_manual(values = use_palette) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
  ) +
  xlim(0, 80) +
  labs(
    y = 'Percentage of guides > 30x in lungs',
    color = '',
    fill = ''
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6),
    legend.text = element_text(size = 6)
  )
```

##### Figure with Y-Pvalues
```{r complexity-dynamics-2j-30x-pval-y, fig.width = 1.5, fig.asp = 1.5}
chunk_data %>% 
  mutate(group = factor(as.character(group), levels = c('Ig control', 'anti-CD4/CD8', 'untreated'))) %>% 
  ggplot(aes(group, guides_over_30_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 30x in lungs',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

#### Treshold 100x

##### Main figure
```{r complexity-dynamics-2j-100x, fig.width = 2, fig.asp = 1}
chunk_data %>% 
  ggplot(aes(`Thy1 B+ cells per mm3 of PT`, guides_over_100_pct,
             color = group,
             fill = group)) +
  geom_point(shape = 21, 
             alpha = 0.8,
             color = 'black',
             size = 1,
             stroke=one_pt/4) +
  scale_fill_manual(values = use_palette) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
  ) +
  xlim(0, 80) +
  labs(
    y = 'Percentage of guides > 100x in lungs',
    color = '',
    fill = ''
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6),
    legend.text = element_text(size = 6)
  )
```

##### Figure with Y-Pvalues
```{r complexity-dynamics-2j-100x-pval-y, fig.width = 1.5, fig.asp = 1.5}
chunk_data %>% 
  mutate(group = factor(as.character(group), levels = c('Ig control', 'anti-CD4/CD8', 'untreated'))) %>% 
  ggplot(aes(group, guides_over_100_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 100x in lungs',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

#### Figure with Pvalues for Thy1 B+ cells per mm3 of PT
```{r complexity-dynamics-2j-B-pval, fig.width = 1.5, fig.asp = 1.5}
chunk_data %>% 
  mutate(group = factor(as.character(group), levels = c('Ig control', 'anti-CD4/CD8', 'untreated'))) %>% 
  ggplot(aes(group, `Thy1 B+ cells per mm3 of PT`,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  guides(fill = 'none', color = 'none') +
  labs(
    # y = 'Percentage of guides > 100x in lungs',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```






### Figure 2J-Third draft: T-cell depletion treatment on lung metastasis
```{r complexity-dynamics-2j-v2-conf}
se <- readRDS(file.path(params$data_dir, 'se.rds'))

# Define groups of samples
data_array <- c(
  "PlatePositionB10","11.78","Neg","Ig control",
  "PlatePositionF10","16.88","Neg","Ig control",
  "PlatePositionD10","11.12","Neg","Ig control",
  "CD4_repeat_2","15.1","Neg","Ig control",
  "CD4_repeat_3","8.6","Neg","Ig control",
  # "UntreatRepl1","41.15","Pos","Ig control",
  # "UntreatRepl2","49.44","Pos","Ig control",
  "UntreatRepl3","19.65","Neg","Ig control",
  "UntreatRepl4","22.14","Neg","Ig control",
  # "UntreatRepl5","20.77","Not ascertained","Ig control",
  "PlatePositionE10","67.80","Pos","anti-CD4/CD8",
  "PlatePositionC10","45.40","Pos","anti-CD4/CD8",
  # "CD4_repeat_1","53.78","Unclear","anti-CD4/CD8",
  "RescueRepl1","77.92","Pos","anti-CD4/CD8",
  # "RescueRepl2","52.16","Not ascertained","anti-CD4/CD8",
  "RescueRepl3","40.93","Pos","anti-CD4/CD8",
  "RescueRepl4","57.11","Pos","anti-CD4/CD8",
  # "RescueRepl5","12.49","Not ascertained","anti-CD4/CD8",
  "4T_LungsT_B1","75.35","Not applicable ","untreated",
  "4T_LungsT_B2","66.78","Not applicable","untreated",
  "4T_LungsT_B3","67.89","Not applicable","untreated",
  "4T_LungsT_B4","74.56","Not applicable","untreated",
  "4T_LungsT_B5","65.77","Not applicable","untreated"
)

use_sample_groups <- matrix(data_array, ncol =4, byrow = TRUE, 
       dimnames = list(c(), c('sample_alias', 'Thy1 B+ cells per mm3 of PT', 'Cas9 staining', 'group'))) %>% 
  data.frame(check.names = FALSE) %>% 
  mutate(`Thy1 B+ cells per mm3 of PT` = as.numeric(`Thy1 B+ cells per mm3 of PT`))
  unique

# use_sample_groups$sample_alias[!use_sample_groups$sample_alias %in% colnames(se)]

use_palette <- c(
  `anti-CD4/CD8` = "#0600fe",
  `Ig control`  = "#cccdcd",
  `untreated`  = "#fffe06"
)

```


```{r complexity-dynamics-2j-v2}
chunk_data <- colData(se) %>% data.frame %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  left_join(use_sample_groups)%>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215,
    group = factor(group, levels = c('anti-CD4/CD8', 'Ig control', 'untreated'))
  )

use_comparisons <- chunk_data$group %>% levels() %>% combn(2,simplify = FALSE)
```

#### Source data
```{r complexity-dynamics-2j-v2-data}
chunk_data %>% 
  dplyr::select(sample_alias, `Thy1 B+ cells per mm3 of PT`, `Cas9 staining`, group, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```

#### Treshold 30x

##### Main figure
```{r complexity-dynamics-2j-v2-30x, fig.width = 2, fig.asp = 1}
chunk_data %>% 
  ggplot(aes(`Thy1 B+ cells per mm3 of PT`, guides_over_30_pct,
             color = group,
             fill = group)) +
  geom_point(shape = 21, 
             alpha = 0.8,
             color = 'black',
             size = 1,
             stroke=one_pt/4) +
  scale_fill_manual(values = use_palette) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
  ) +
  xlim(0, 80) +
  labs(
    y = 'Percentage of guides > 30x in lungs',
    color = '',
    fill = ''
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6),
    legend.text = element_text(size = 6)
  )
```

##### Figure with Y-Pvalues
```{r complexity-dynamics-2j-v2-30x-pval-y, fig.width = 1.5, fig.asp = 1.5}
chunk_data %>% 
  mutate(group = factor(as.character(group), levels = c('Ig control', 'anti-CD4/CD8', 'untreated'))) %>% 
  ggplot(aes(group, guides_over_30_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 30x in lungs',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

#### Treshold 100x

##### Main figure
```{r complexity-dynamics-2j-v2-100x, fig.width = 2, fig.asp = 1}
chunk_data %>% 
  ggplot(aes(`Thy1 B+ cells per mm3 of PT`, guides_over_100_pct,
             color = group,
             fill = group)) +
  geom_point(shape = 21, 
             alpha = 0.8,
             color = 'black',
             size = 1,
             stroke=one_pt/4) +
  scale_fill_manual(values = use_palette) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
  ) +
  xlim(0, 80) +
  labs(
    y = 'Percentage of guides > 100x in lungs',
    color = '',
    fill = ''
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6),
    legend.text = element_text(size = 6)
  )
```

##### Figure with Y-Pvalues
```{r complexity-dynamics-2j-v2-100x-pval-y, fig.width = 1.5, fig.asp = 1.5}
chunk_data %>% 
  mutate(group = factor(as.character(group), levels = c('Ig control', 'anti-CD4/CD8', 'untreated'))) %>% 
  ggplot(aes(group, guides_over_100_pct,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1)
    ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides > 100x in lungs',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```

#### Figure with Pvalues for Thy1 B+ cells per mm3 of PT
```{r complexity-dynamics-2j-v2-B-pval, fig.width = 1.5, fig.asp = 1.5}
chunk_data %>% 
  mutate(group = factor(as.character(group), levels = c('Ig control', 'anti-CD4/CD8', 'untreated'))) %>% 
  ggplot(aes(group, `Thy1 B+ cells per mm3 of PT`,
             color = group,
             fill = group)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  guides(fill = 'none', color = 'none') +
  labs(
    # y = 'Percentage of guides > 100x in lungs',
    x = ''
  ) +
  stat_compare_means(
    aes(label = paste0("p = ", after_stat(p.format))),
    comparisons = use_comparisons,
    method = 'wilcox.test',
    size = 0.4*geom_text_size,
    bracket.size = one_pt/4
  ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )

```







### Figure 2G
```{r complexity-dynamics-2g-conf}
se <- readRDS(file.path(params$data_dir, 'se.rds'))

# Define groups of samples
data_array <- c(
  "NSG lung tumor","dC9NSG_LungIV_C167_2","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_C167_3","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_C167_4","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_C167_5","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_LLC1_1","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_LLC1_2","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_LLC1_3","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_LLC1_4","Lung tumor","NSG",
  "NSG lung tumor","dC9NSG_LungIV_LLC1_5","Lung tumor","NSG",
  "Syngeneic lung tumor","dC9BL6_LungIV_C167_1","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_C167_2","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_C167_3","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_C167_4","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_C167_5","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_LLC1_1","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_LLC1_2","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_LLC1_3","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_LLC1_4","Lung tumor","Syngeneic",
  "Syngeneic lung tumor","dC9BL6_LungIV_LLC1_5","Lung tumor","Syngeneic",
  "NSG liver mets","dC9NSG_LiverIV_C167_1","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_C167_2","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_C167_3","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_C167_4","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_C167_5","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_LLC1_1","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_LLC1_2","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_LLC1_3","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_LLC1_4","Liver mets","NSG",
  "NSG liver mets","dC9NSG_LiverIV_LLC1_5","Liver mets","NSG",
  "Syngeneic liver mets","dC9BL6_LiverIV_C167_3","Liver mets","Syngeneic",
  "Syngeneic liver mets","dC9BL6_LiverIV_C167_5","Liver mets","Syngeneic",
  "Syngeneic liver mets","dC9BL6_LiverIV_LLC1_1","Liver mets","Syngeneic",
  "Syngeneic liver mets","dC9BL6_LiverIV_LLC1_3","Liver mets","Syngeneic",
  "Syngeneic liver mets","dC9BL6_LiverIV_LLC1_4","Liver mets","Syngeneic",
  "Syngeneic liver mets","dC9BL6_LiverIV_LLC1_5","Liver mets","Syngeneic"
)

use_sample_groups <- matrix(data_array, ncol = 4, byrow = TRUE, 
       dimnames = list(c(), c('group', 'sample_alias', 'group_origin', 'group_model'))) %>% 
  data.frame %>% 
  unique

# use_sample_groups$sample_alias[!use_sample_groups$sample_alias %in% colnames(se)]

use_palette <- c(
  Syngeneic  = 'black',
  NSG = 'white'
)

chunk_data <- colData(se) %>% data.frame %>% 
  filter(sample_alias %in% use_sample_groups$sample_alias) %>%
  left_join(use_sample_groups)%>% 
  mutate(
    guides_over_100_pct = guides_over_100 / 2215,
    guides_over_30_pct = guides_over_30 / 2215,
    guides_over_1_pct = guides_over_1 / 2215,
    group_model = factor(group_model, levels = c('NSG', 'Syngeneic'))
  )


```

#### Source data
```{r complexity-dynamics-2g-data}
chunk_data %>% 
  dplyr::select(sample_alias, group, group_origin, group_model, guides_over_1_pct, guides_over_30_pct, guides_over_100_pct) %>% 
  mutate_at(vars(guides_over_1_pct, guides_over_30_pct, guides_over_100_pct), 
            ~ round(.*100, 2)) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Source data for the plots',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )
```

#### Threshold 30x
```{r complexity-dynamics-2g-30x, fig.width = 2}
chunk_data %>% 
  ggplot(aes(group_model, guides_over_30_pct,
             color = group_model,
             fill = group_model)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  # scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    transform = 'log'
    ) +
  facet_grid2(. ~ group_origin,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test",
    # label = "p.adj.format",
    # p.adjust.method = "holm", 
    # p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  # stat_compare_means(
  #   comparisons = use_comparisons,
  #   method = 'wilcox.test',
  #   size = 0.4*geom_text_size,
  #   bracket.size = one_pt/4
  # ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )
```

#### Threshold 100x
```{r complexity-dynamics-2g-100x, fig.width = 2}
chunk_data %>% 
  ggplot(aes(group_model, guides_over_100_pct,
             color = group_model,
             fill = group_model)) +
  geom_quasirandom(shape = 21, 
                   alpha = 0.8, 
                   color = 'black', 
                   size = 1, 
                   stroke=one_pt/4
                   ) +
  scale_fill_manual(values = use_palette) +
  # scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    transform = 'log'
    ) +
  facet_grid2(. ~ group_origin,
              axes = "all",
              scales = 'free_y'
              ) +
  guides(fill = 'none', color = 'none') +
  labs(
    y = 'Percentage of guides',
    x = ''
  ) +
  geom_pwc(
    method = "wilcox_test",
    # label = "p.adj.format",
    # p.adjust.method = "holm", 
    # p.adjust.by = "panel",
    label.size = 0.4*geom_text_size,
    size = one_pt/4
  ) +
  # stat_compare_means(
  #   comparisons = use_comparisons,
  #   method = 'wilcox.test',
  #   size = 0.4*geom_text_size,
  #   bracket.size = one_pt/4
  # ) +
  theme(
    axis.text =  element_text(size=6),
    axis.title =  element_text(size=6),
    plot.title = element_text(size=6, hjust = 0.5),
    strip.text = element_text(size = 6)
  )
```
