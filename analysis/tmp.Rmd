---
title: "CRISPR immunorejection analysis"
subtitle: "Compare sgRNA abundance distributions between conditions"
author: "Francesc Castro-Giner"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
params:
  date: '`r format(Sys.Date(), "%B %d, %Y")`'
  rawdata_dir: ./data/crispr
  data_dir: ./output/crispr/hsapiens_2180
  output_dir: ./output/crispr/hsapiens_2180/dist_test
  ncpu: 4
---

## Load libraries, additional functions and data

Setup environment
```{r setup, include=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(results='asis', echo=TRUE, message=FALSE, warning=FALSE, error=FALSE, fig.align = 'center', fig.width = 3.5, fig.asp = 0.618, dpi = 600, dev = c("png", "pdf"), engine.opts = list(bash = "-l"))

options(stringsAsFactors = FALSE)

use_seed <- 1100101

set.seed(use_seed)

dir.create(params$output_dir, recursive = TRUE, showWarnings = FALSE)
```

<!-- Setup css style -->
<!-- ```{css style settings, echo = FALSE} -->
<!-- blockquote { -->
<!--     padding: 10px 20px; -->
<!--     margin: 0 0 20px; -->
<!--     font-size: 14px; -->
<!--     border-left: 5px solid #eee; -->
<!-- } -->
<!-- ``` -->


Load packages
```{r load-libraries}
library(tidyverse)
library(showtext)
library(foreach)
library(SummarizedExperiment)
library(DT)
library(colorblindr)
library(ggdendro)
library(RColorBrewer)
library(circlize)
library(Hmisc)
library(ComplexHeatmap)
library(ineq)
library(knitr)
library(kableExtra)
library(magrittr)
library(ggrepel)
library(ggpubr)
library(ggbeeswarm)
library(ggridges)
```


Load ggplot theme
```{r ggplot-theme, include=TRUE}
source("./configuration/rmarkdown/ggplot_theme.R")
```

Load Summarized Experiment object
```{r load-se}
se <- readRDS(file.path(params$data_dir, 'se.rds'))
se$immunogen_mmmodel <- paste(se$immunogen, se$mm_model_type, sep = '_')
```

For StealTHY Immunocompetent comparisons we removed replacement samples with low coverage (replicates 8 to 10)
```{r remove_replacement_samples}
use_cols <- !colnames(se) %in% c('Replacement_Sample2', 'Replacement_Sample6', 'Replacement_Sample8',
                    'Replacement_Sample3', 'Replacement_Sample7', 'Replacement_Sample9')
se <- se[,use_cols]
```

## Configure tests


Run comparison of detected sgRNA and abundance distributions across conditions and sample type (tumor or mets)
```{r run-comparisons-sample_type-conditions, eval = FALSE}
use_data <- colData(se) %>% 
  data.frame %>%
  mutate(sample_type = factor(sample_type)) %>% 
  filter(sample_type %in% c('whole_lung', 'whole_tumor'))

# Compare number of guides over 30 immunogen_mmmodel
use_stas <- use_data %>% group_by(sample_type, immunogen_mmmodel) %>% 
  summarise(
    n = n(),
    mean = mean(guides_over_30),
    median = median(guides_over_30)
  )
comp_guides_detected <- compare_means(guides_over_30 ~ immunogen_mmmodel,  data = use_data, group.by = 'sample_type') %>% 
  left_join(use_stas, by = c("sample_type", "group1" ="immunogen_mmmodel")) %>% 
  dplyr::rename(n_group1 = n, mean_group1 = mean, median_group1 = median)%>% 
  left_join(use_stas, by = c("sample_type", "group2" ="immunogen_mmmodel")) %>% 
  dplyr::rename(n_group2 = n, mean_group2 = mean, median_group2 = median)

# K-S test to compare distributions.K-S test is two samples comparison (wihtout replicates). Here I am combining all the replicates from the same group
i <- 1
comp_abundance_dist <-foreach(i = 1:nrow(comp_guides_detected), .combine = rbind) %do% {
  x <- comp_guides_detected[i,] %>% dplyr::select(sample_type, group1, group2)
  use_colData <- colData(se) %>% data.frame %>%  
      filter(sample_type == x$sample_type & immunogen_mmmodel %in% c(x$group1, x$group2))
  use_assay <- assay(se[,use_colData$sample_alias], 'cpm') %>% 
      as.data.frame(check.names = F) %>% 
      rownames_to_column('guide') %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData)
  
   use_assay <- apply(assay(se[,use_colData$sample_alias], 'cpm'), 2, function(x) sort(x, decreasing = TRUE))  %>% 
      as.data.frame(check.names = F) %>% 
      mutate(guide = 1:nrow(se)) %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData %>% dplyr::select(sample_alias, immunogen_mmmodel)) %>% 
      group_by(guide, immunogen_mmmodel) %>% 
      summarise(cpm = mean(cpm))
  ks.res <- ks.test(cpm ~ immunogen_mmmodel, data = use_assay)
  use_stas <- use_assay %>% group_by(immunogen_mmmodel) %>% 
    summarise(
      n = n(),
      mean = mean(cpm),
      median = median(cpm)
    ) %>% 
    column_to_rownames('immunogen_mmmodel')
  x %>% mutate(
    ks.D = round(ks.res$statistic, 3),
    p.value = ks.res$p.value,
    mean_group1 = round(use_stas[x$group1, 'mean'], 2), 
    median_group1 =  round(use_stas[x$group1, 'median'], 2),
    mean_group2 =  round(use_stas[x$group2, 'mean'], 2), 
    median_group2 =  round(use_stas[x$group2, 'median'], 2),
  )
}

saveRDS(comp_guides_detected, file = file.path(params$output_dir, 'comp_guides_detected.rds'))
saveRDS(comp_abundance_dist, file = file.path(params$output_dir, 'comp_abundance_dist.rds'))

```


```{r load-comparisons-sample_type-conditions}
comp_guides_detected <- readRDS(file.path(params$output_dir, 'comp_guides_detected.rds'))
comp_abundance_dist <- readRDS(file.path(params$output_dir, 'comp_abundance_dist.rds'))
```

Run comparison of detected sgRNA and abundance distributions across conditions and sample type (global comparisons)
```{r run-comparisons-global-conditions, eval = FALSE}
use_data <- colData(se) %>% 
  data.frame %>% 
  filter(sample_type %in% c('whole_lung', 'whole_tumor'))

# Compare number of guides over 30 for vector immunogen_mmmodel
use_stas <- use_data %>% group_by(immunogen_mmmodel) %>% 
  summarise(
    n = n(),
    mean = mean(guides_over_30),
    median = median(guides_over_30)
  )
comp_guides_detected_global <- compare_means(guides_over_30 ~ immunogen_mmmodel,  data = use_data) %>% 
  left_join(use_stas, by = c("group1" ="immunogen_mmmodel")) %>% 
  dplyr::rename(n_group1 = n, mean_group1 = mean, median_group1 = median)%>% 
  left_join(use_stas, by = c("group2" ="immunogen_mmmodel")) %>% 
  dplyr::rename(n_group2 = n, mean_group2 = mean, median_group2 = median)


# K-S test to compare distributions.K-S test is two samples comparison (wihtout replicates). Here I am combining all the replicates from the same group
i <- 1
comp_abundance_dist_global <-foreach(i = 1:nrow(comp_guides_detected_global), .combine = rbind) %do% {
  x <- comp_guides_detected_global[i,] %>% dplyr::select(group1, group2)
  use_colData <- colData(se) %>% data.frame %>%  
      filter(immunogen_mmmodel %in% c(x$group1, x$group2))
  use_assay <- assay(se[,use_colData$sample_alias], 'cpm') %>% 
      as.data.frame(check.names = F) %>% 
      rownames_to_column('guide') %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData)
  
  use_assay <- apply(assay(se[,use_colData$sample_alias], 'cpm'), 2, function(x) sort(x, decreasing = TRUE))  %>% 
      as.data.frame(check.names = F) %>% 
      mutate(guide = 1:nrow(se)) %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData %>% dplyr::select(sample_alias, immunogen_mmmodel)) %>% 
      group_by(guide, immunogen_mmmodel) %>% 
      summarise(cpm = mean(cpm))
  ks.res <- ks.test(cpm ~ immunogen_mmmodel, data = use_assay)
  use_stas <- use_assay %>% group_by(immunogen_mmmodel) %>% 
    summarise(
      n = n(),
      mean = mean(cpm),
      median = median(cpm)
    ) %>% 
    column_to_rownames('immunogen_mmmodel')
  x %>% mutate(
    ks.D = round(ks.res$statistic, 3),
    p.value = ks.res$p.value,
    mean_group1 = round(use_stas[x$group1, 'mean'], 2), 
    median_group1 =  round(use_stas[x$group1, 'median'], 2),
    mean_group2 =  round(use_stas[x$group2, 'mean'], 2), 
    median_group2 =  round(use_stas[x$group2, 'median'], 2),
  )
}

saveRDS(comp_guides_detected_global, file = file.path(params$output_dir, 'comp_guides_detected_global.rds'))
saveRDS(comp_abundance_dist_global, file = file.path(params$output_dir, 'comp_abundance_dist_global.rds'))

```


```{r load-comparisons-global-conditions}
comp_guides_detected_global <- readRDS(file.path(params$output_dir, 'comp_guides_detected_global.rds'))
comp_abundance_dist_global <- readRDS(file.path(params$output_dir, 'comp_abundance_dist_global.rds'))
```

Define comparisons for primary tumor and metastases
```{r define-comparisons-sample_type}
# x <- colData(se) %>% data.frame
# x$mm_model_type %>% table %>% data.frame
# x_g <- x %>% group_by(sample_type, immunogen_mmmodel) %>% summarise(n = n(), samples = paste(sample_alias, collapse =";"))

comp_list_by_sample_type <- list(
  A = list(
    c('StealTHY_Imm.competent', 'StealTHY_Imm.deficient')
  )
)
# comp_list_by_sample_type = list(
#   A = list(
#     IC = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent') %>% 
#       # filter(!sample_alias %in% c('Replacement_Sample2', 'Replacement_Sample6', 'Replacement_Sample8')) %>% 
#       filter(replicate %in% 1:7) %>% 
#       arrange(replicate) %>% 
#       pull(sample_alias),
#     ID = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent') %>% 
#       # filter(!sample_alias %in% c('Replacement_Sample3', 'Replacement_Sample7', 'Replacement_Sample9')) %>% 
#       filter(replicate %in% 1:7) %>% 
#       arrange(replicate) %>% 
#       pull(sample_alias)
#     )
# )
```

Define global comparisons
```{r define-comparisons-global}
# x <- colData(se) %>% data.frame
# x$global_immunogen_mmmodel %>% table %>% data.frame
# x_g <- x %>% group_by(global_immunogen_mmmodel) %>% summarise(n = n(), samples = paste(sample_alias, collapse =";"))

comp_list_global <- list(
  A = list(
    c('StealTHY_Imm.competent', 'StealTHY_Imm.deficient')
  )
)
# 
# comp_list_global <-  list(
#   A = list(
#     IC = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent') %>% 
#       # filter(!sample_alias %in% c('Replacement_Sample2', 'Replacement_Sample6', 'Replacement_Sample8')) %>% 
#       filter(replicate %in% 1:7) %>% 
#       arrange(replicate) %>% 
#       pull(sample_alias),
#     ID = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent') %>% 
#       # filter(!sample_alias %in% c('Replacement_Sample3', 'Replacement_Sample7', 'Replacement_Sample9')) %>% 
#       filter(replicate %in% 1:7) %>% 
#       arrange(replicate) %>% 
#       pull(sample_alias)
#     )
# )


# x <- colData(se) %>% data.frame
# use_vvm <- x['PlatePositionG10',] %>% pull(global_immunogen_mmmodel_invitro_cas9transfection_grouped)
# x %>% filter(global_immunogen_mmmodel_invitro_cas9transfection_grouped == use_vvm) %>%
#   select(sample_alias, global_immunogen_mmmodel, global_immunogen_mmmodel_invitro, global_immunogen_mmmodel_invitro_cas9transfection) %>%
#   unique


```

Define comparisons for modality test
```{r define-comparisons-modality}
x <- colData(se) %>% data.frame

comp_list_modality <- list(
  `A.StealTHY_ID--over--StealTHY_IC.tumor` = list(
    `StealTHY_Imm.deficient` = x %>% filter(immunogen_mmmodel == 'StealTHY_Imm.deficient' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `StealTHY_Imm.competent` = x %>% filter(immunogen_mmmodel == 'StealTHY_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias)
  ),
  `B.StealTHY_ID--over--StealTHY_IC.lung` = list(
    `StealTHY_Imm.deficient` = x %>% filter(immunogen_mmmodel == 'StealTHY_Imm.deficient' & sample_type == 'whole_lung') %>% pull(sample_alias),
    `StealTHY_Imm.competent` = x %>% filter(immunogen_mmmodel == 'StealTHY_Imm.competent' & sample_type == 'whole_lung') %>% pull(sample_alias)
  ),
  
  `C.StealTHY_IC--over--in_vitro.tumor` = list(
    `StealTHY_Imm.competent` = x %>% filter(immunogen_mmmodel == 'StealTHY_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `Thy_In_vitro` = x %>% filter(immunogen_mmmodel == 'Thy_In_vitro') %>% pull(sample_alias)
  ),
  
  `D.StealTHY_ID--over--in_vitro.tumor` = list(
    `StealTHY_Imm.deficient` = x %>% filter(immunogen_mmmodel == 'StealTHY_Imm.deficient' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `Thy_In_vitro` = x %>% filter(immunogen_mmmodel == 'Thy_In_vitro') %>% pull(sample_alias)
  ),
  
  `E.no_immunogen--over--GFP.tumor` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `GFP_Imm.competent` = x %>% filter(immunogen_mmmodel == 'GFP_Imm.competent'  & sample_type == 'whole_tumor') %>% pull(sample_alias)
  ),
  `F.no_immunogen--over--dCas9-THY.tumor` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `dCas9-THY_Imm.competent` = x %>% filter(immunogen_mmmodel == 'dCas9-THY_Imm.competent'  & sample_type == 'whole_tumor') %>% pull(sample_alias)
  ),
  `G.no_immunogen--over--GFP_IC.tumor` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `dCas9-GFP_Imm.competent` = x %>% filter(immunogen_mmmodel == 'dCas9-GFP_Imm.competent'  & sample_type == 'whole_tumor') %>% pull(sample_alias)
  ),
  `H.no_immunogen--over--GFP_ID.tumor` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    `dCas9-GFP_Imm.deficient` = x %>% filter(immunogen_mmmodel == 'dCas9-GFP_Imm.deficient'  & sample_type == 'whole_tumor') %>% pull(sample_alias)
  ),
  `I.no_immunogen--over--in_vitro.tumor` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_tumor') %>% pull(sample_alias),
    Thy_In_vitro = x %>% filter(immunogen_mmmodel == 'Thy_In_vitro') %>% pull(sample_alias)
  ),
  
  `J.no_immunogen--over--GFP.lung` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_lung') %>% pull(sample_alias),
    `GFP_Imm.competent` = x %>% filter(immunogen_mmmodel == 'GFP_Imm.competent'  & sample_type == 'whole_lung') %>% pull(sample_alias)
  ),
  `K.no_immunogen--over--dCas9-THY.lung` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_lung') %>% pull(sample_alias),
    `'dCas9-THY_Imm.competent` = x %>% filter(immunogen_mmmodel == 'dCas9-THY_Imm.competent'  & sample_type == 'whole_lung') %>% pull(sample_alias)
  ),
  `L.no_immunogen--over--GFP_IC.lung` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_lung') %>% pull(sample_alias),
    `dCas9-GFP_Imm.competent` = x %>% filter(immunogen_mmmodel == 'dCas9-GFP_Imm.competent'  & sample_type == 'whole_lung') %>% pull(sample_alias)
  ),
  `M.no_immunogen--over--GFP_ID.lung` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_lung') %>% pull(sample_alias),
    `dCas9-GFP_Imm.deficient` = x %>% filter(immunogen_mmmodel == 'dCas9-GFP_Imm.deficient'  & sample_type == 'whole_lung') %>% pull(sample_alias)
  ),
  `N.no_immunogen--over--in_vitro.lung` = list(
    `no_immunogen_Imm.competent` = x %>% filter(immunogen_mmmodel == 'no_immunogen_Imm.competent' & sample_type == 'whole_lung') %>% pull(sample_alias),
    `Thy_In_vitro` = x %>% filter(immunogen_mmmodel == 'Thy_In_vitro') %>% pull(sample_alias)
  )
)

```

Additional comparisons to test detected sgRNA and abundance distributions
```{r conf-comparisons-additional}
x <- colData(se) %>% data.frame
# x %>% group_by(vector_mmodel) %>% summarise(n = n(), samples = paste(sample_alias, collapse =";")) %>% data.frame
# x %>% group_by(global_vector_mmodel) %>% summarise(n = n(), samples = paste(sample_alias, collapse =";")) %>% data.frame
# x %>% group_by(mouse_model_global) %>% summarise(n = n(), samples = paste(sample_alias, collapse =";")) %>% data.frame
# R S

comp_list_additional <- list(
  A = list(
    StealTHY_IC_Lung = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      # filter(!sample_alias %in% c('Replacement_Sample3', 'Replacement_Sample7', 'Replacement_Sample9')) %>% 
      filter(replicate %in% 1:7) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    StealTHY_IC_Tumor = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      # filter(!sample_alias %in% c('Replacement_Sample2', 'Replacement_Sample6', 'Replacement_Sample8')) %>% 
      filter(replicate %in% 1:7) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    paired = TRUE
    ),
  B = list(
    StealTHY_ID_Lung = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    StealTHY_ID_Tumor = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    paired = TRUE
    ),
  C = list(
   StealTHY_IC_Tumor = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      # filter(!sample_alias %in% c('Replacement_Sample2', 'Replacement_Sample6', 'Replacement_Sample8')) %>% 
      filter(replicate %in% 1:7) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
   Thy1_post_Cas9_In_vitro = x %>% filter(description == 'Thy1 post-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
     pull(sample_alias)
    ),
  D = list(
    StealTHY_ID_Tumor = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    Thy1_post_Cas9_In_vitro = x %>% filter(description == 'Thy1 post-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
     pull(sample_alias)
  ),
  E = list(
    StealTHY_ID_Tumor = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    StealTHY_IC_Tumor = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      # filter(!sample_alias %in% c('Replacement_Sample2', 'Replacement_Sample6', 'Replacement_Sample8')) %>% 
      filter(replicate %in% 1:7) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  F = list(
    StealTHY_ID_Lung = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    StealTHY_IC_Lung = x %>% filter(immunogen == 'StealTHY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      # filter(!sample_alias %in% c('Replacement_Sample3', 'Replacement_Sample7', 'Replacement_Sample9')) %>% 
      filter(replicate %in% 1:7) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  G = list(
    No_immunogen_IC_Tumor = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    Thy1_pre_Cas9_In_vitro = x %>% filter(description == 'Thy1 pre-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
      filter(!sample_alias %in% c('B1Position_HumanPlate2')) %>%
     pull(sample_alias)
  ),
  H = list(
    GFP_IC_Tumor = x %>% filter(immunogen == 'GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    Thy1_pre_Cas9_In_vitro = x %>% filter(description == 'Thy1 pre-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
      filter(!sample_alias %in% c('B1Position_HumanPlate2')) %>%
     pull(sample_alias)
  ),
  I = list(
    `dCAS9-THY_IC_Tumor` = x %>% filter(immunogen == 'dCas9-THY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    Thy1_pre_Cas9_In_vitro = x %>% filter(description == 'Thy1 pre-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
      filter(!sample_alias %in% c('B1Position_HumanPlate2')) %>%
     pull(sample_alias)
  ),
  J = list(
    `dCas9-GFP_IC_Tumor` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    Thy1_pre_Cas9_In_vitro = x %>% filter(description == 'Thy1 pre-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
      filter(!sample_alias %in% c('B1Position_HumanPlate2')) %>%
     pull(sample_alias)
  ),
  K = list(
    `dCas9-GFP_ID_Tumor` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    Thy1_pre_Cas9_In_vitro = x %>% filter(description == 'Thy1 pre-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
      filter(!sample_alias %in% c('B1Position_HumanPlate2')) %>%
     pull(sample_alias)
  ),
  L = list(
    Thy1_post_Cas9_In_vitro = x %>% filter(description == 'Thy1 post-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
     pull(sample_alias),
    Thy1_pre_Cas9_In_vitro = x %>% filter(description == 'Thy1 pre-Cas9 transfection' & mm_model_type == 'In_vitro' & sample_type == 'In vitro') %>% 
    filter(!sample_alias %in% c('B1Position_HumanPlate2')) %>%
     pull(sample_alias)
  ),
  M = list(
    GFP_IC_Tumor = x %>% filter(immunogen == 'GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Tumor = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  N = list(
    `dCAS9-THY_IC_Tumor` = x %>% filter(immunogen == 'dCas9-THY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Tumor = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  O = list(
    `dCas9-GFP_IC_Tumor` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Tumor = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  P = list(
    `dCas9-GFP_ID_Tumor` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Tumor = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  Q = list(
    `dCas9-GFP_ID_Tumor` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    `dCas9-GFP_IC_Tumor` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_tumor') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  
  
  R = list(
    GFP_IC_Lung = x %>% filter(immunogen == 'GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Lung = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  S = list(
    `dCAS9-THY_IC_Lung` = x %>% filter(immunogen == 'dCas9-THY' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Lung = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  T = list(
    `dCas9-GFP_IC_Lung` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Lung = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  U = list(
    `dCas9-GFP_ID_Lung` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Lung = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  V = list(
    `dCas9-GFP_ID_Lung` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    `dCas9-GFP_IC_Lung` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'whole_lung') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  W = list(
    `GFP_IC_Ln` = x %>% filter(immunogen == 'GFP' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Ln = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  X = list(
    `dCas9-THY1_IC_Ln` = x %>% filter(immunogen == 'dCas9-THY' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Ln = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  Y = list(
    `dCas9-GFP_IC_Ln` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Ln = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  Z = list(
    `dCas9-GFP_ID_Ln` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Ln = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  ZA = list(
    `dCas9-GFP_ID_Ln` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    `dCas9-GFP_IC_Ln` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'met_lymph') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  ZB = list(
    `GFP_IC_Liver` = x %>% filter(immunogen == 'GFP' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Liver = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  ZC = list(
    `dCas9-THY1_IC_Liver` = x %>% filter(immunogen == 'dCas9-THY' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Liver = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  ZD = list(
    `dCas9-GFP_IC_Liver` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Liver = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  ZE = list(
    `dCas9-GFP_ID_Liver` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    No_immunogen_IC_Liver = x %>% filter(immunogen == 'no_immunogen' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  ),
  ZD = list(
    `dCas9-GFP_ID_Liver` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.deficient' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias),
    `dCas9-GFP_IC_Liver` = x %>% filter(immunogen == 'dCas9-GFP' & mm_model_type == 'Imm.competent' & sample_type == 'met_liver') %>% 
      filter(replicate %in% 1:6) %>% 
      arrange(replicate) %>% 
      pull(sample_alias)
  )
)

```

Run comparison of detected sgRNA and abundance distributions across groups from additional comparisons
```{r run-comparisons-additional-conditions, eval = FALSE}
i <- names(comp_list_additional)[1]
comp_guides_detected <- foreach(i = names(comp_list_additional), .combine = rbind) %do% {
  comp_i <- comp_list_additional[[i]] 
  use_data <- colData(se) %>% 
    data.frame %>% 
    mutate(
      group = ifelse(sample_alias %in% comp_i[[1]], names(comp_i)[1], NA),
      group = ifelse(sample_alias %in% comp_i[[2]], names(comp_i)[2], group)
    ) %>% 
    filter(!is.na(group))
  
  # Compare number of guides over 30 immunogen_mmmodel
  use_stas <- use_data %>% group_by(group) %>% 
    summarise(
      n = n(),
      mean = mean(guides_over_30),
      median = median(guides_over_30)
    )
  compare_means(guides_over_30 ~ group,  data = use_data) %>% 
    left_join(use_stas, by = c("group1" ="group")) %>% 
    dplyr::rename(n_group1 = n, mean_group1 = mean, median_group1 = median)%>% 
    left_join(use_stas, by = c("group2" ="group")) %>% 
    dplyr::rename(n_group2 = n, mean_group2 = mean, median_group2 = median) %>% 
    mutate(comparison = i) %>% 
    dplyr::select(comparison, everything())
}

# K-S test to compare distributions.K-S test is two samples comparison (wihtout replicates). Here I am combining all the replicates from the same group
comp_abundance_dist <- foreach(i = names(comp_list_additional), .combine = rbind) %do% {
  x <- comp_guides_detected %>% filter(comparison == i) %>% dplyr::select(group1, group2)
  comp_i <- comp_list_additional[[i]]
  
  use_data <- colData(se) %>% 
    data.frame %>% 
    mutate(
      group = ifelse(sample_alias %in% comp_i[[1]], names(comp_i)[1], NA),
      group = ifelse(sample_alias %in% comp_i[[2]], names(comp_i)[2], group)
    ) %>% 
    filter(!is.na(group))
   
  use_assay <- assay(se[,use_data$sample_alias], 'cpm') %>% 
      as.data.frame(check.names = F) %>% 
      rownames_to_column('guide') %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_data)
  
  ks.res <- ks.test(cpm ~ group, data = use_assay)
  
  use_stas <- use_assay %>% group_by(group) %>% 
    summarise(
      n = n(),
      mean = mean(cpm),
      median = median(cpm)
    ) %>% 
    column_to_rownames('group')
  x %>% 
    mutate(
      comparison = i,
      ks.D = round(ks.res$statistic, 3),
      p.value = format.pval(ks.res$p.value),
      mean_group1 = round(use_stas[x$group1, 'mean'], 2),
      median_group1 =  round(use_stas[x$group1, 'median'], 2),
      mean_group2 =  round(use_stas[x$group2, 'mean'], 2),
      median_group2 =  round(use_stas[x$group2, 'median'], 2)
  ) %>% 
    dplyr::select(comparison, everything())
}


saveRDS(comp_guides_detected, file = file.path(params$output_dir, 'comp_additional_guides_detected.rds'))
saveRDS(comp_abundance_dist, file = file.path(params$output_dir, 'comp_additional_abundance_dist.rds'))

```

```{r load-comparisons-additional-conditions}
comp_guides_detected_additional <- readRDS(file.path(params$output_dir, 'comp_additional_guides_detected.rds'))
comp_abundance_dist_additional <- readRDS(file.path(params$output_dir, 'comp_additional_abundance_dist.rds'))
```


## Tumor samples
Analysis 3 : Please perform unpaired comparison tests for (1) the total no. of detected sgRNAs and (2) distribution between the following tumor samples
```{r test-dist-tumor-conf}
use_sample_type <- 'whole_tumor'
comp_list <- comp_list_by_sample_type
comp_list_unlisted <- foreach(x = comp_list, .combine = c) %do% x
comp_list_df_double <- foreach(x = comp_list_unlisted, .combine = rbind) %do% {rbind(x, rev(x))} %>% 
  data.frame %>% 
  set_names(c('group1', 'group2'))
use_colData <- colData(se) %>% data.frame %>% 
    filter(sample_type == use_sample_type)
```

### Number of detected guides

#### Table
```{r test-dist-tumor-detected-tab}
comp_guides_detected %>% 
  filter(sample_type == use_sample_type) %>% 
  mutate(
    p = format.pval(p),
    p.adj = format.pval(p.adj),
  ) %>% 
  dplyr::select(-sample_type, -p.format, -.y.) %>% 
  inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide abundance. P value by two-sided Wiloxon test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Boxplot
```{r test-dist-tumor-detected-boxplot, fig.width=2, fig.asp = 1.5}
comp_name <-  names(comp_list)[1]
res_plot <- foreach(comp_name = names(comp_list)) %do% {
  use_comps <-  comp_list[[comp_name]]
  use_colData %>% 
    filter(immunogen_mmmodel %in% unlist(use_comps)) %>% 
    mutate(immunogen_mmmodel = factor(immunogen_mmmodel, levels = unlist(use_comps))) %>% 
    ggplot(aes(immunogen_mmmodel, guides_over_30, color = immunogen_mmmodel)) +
      geom_boxplot(outlier.shape = NA) + 
      geom_beeswarm() +
      scale_y_continuous(expand = expansion(0.1)) +
      scale_color_brewer(type = 'qual', palette = 'Paired') +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
      stat_compare_means(comparisons = use_comps, method = 'wilcox.test', size = geom_text_size) +
      labs(
        x = ''
      ) +
      guides(
        color = 'none'
      )
}
plot_grid(plotlist = res_plot, labels =  names(comp_list), align = 'hv')


```


### Guide distribution

#### Table
We compared the distribution of guides abundances for each group using two-sided Kolmogorov-Smirnov (K-S) test. For each sample we ranked guides based on normalized abundance (CPM) distribution. Then the corresponding value for each rank was obtained averaging the CPM in samples from each group. 
```{r test-dist-tumor-distribution-tab}
comp_abundance_dist %>% 
  filter(sample_type == use_sample_type) %>% 
  mutate(
    p.value = format.pval(p.value),
  ) %>% 
  dplyr::select(-sample_type) %>% 
  inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide distribution using two-sided Kolmogorov-Smirnov (K-S) test.',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Density plot
```{r test-dist-tumor-distribution-ridges_plot, fig.asp = 1, fig.width = 5.2}
use_comps_i <- comp_list_unlisted[1]
res_plot <- foreach(use_comps_i = comp_list_unlisted) %do% {
    use_samples <- use_colData %>% 
      filter(immunogen_mmmodel %in% use_comps_i) %>% 
      pull(sample_alias)
    use_assay <- assay(se[,use_samples], 'cpm') %>% 
      as.data.frame(check.names = F) %>% 
      rownames_to_column('guide') %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData)
    use_assay %>% 
      # mutate(sample_alias = fct_reorder(sample_alias, use_comps_i)) %>%
      ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel)) +
      geom_density_ridges(color = 'white', quantile_lines = TRUE) +
      scale_fill_OkabeIto(alpha = 0.8) +
      scale_x_log10(expand = c(0, 0)) +
      scale_y_discrete(expand = c(0, 0)) +
      labs(y = '') +
      guides(fill = 'none') +
      facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y') +
      theme_ridges()
}


plot_grid(
  plotlist = res_plot, 
  labels = names(comp_list)
  )
```

#### Density plot StealTHY IC vs ID
```{r test-dist-tumor-distribution-ridges_plot-stealthy-ic-id, fig.asp = 0.667, fig.width = 1.5625}
sample_ord <- rev(c(
  # 'Replacement_Sample4',
  'C1Position_HumanPlate2',
  'C2Position_HumanPlate2',
  'E2Position_HumanPlate2',
  'E1Position_HumanPlate2',
  'G1Position_HumanPlate2',
  # 'A2Position_HumanPlate2',
  
  'C4Position_HumanPlate2',
  'C3Position_HumanPlate2',
  'G3Position_HumanPlate2',
  'E3Position_HumanPlate2',
  'A4Position_HumanPlate2'
  # 'A3Position_HumanPlate2',
  ))

use_comps_i <- comp_list_unlisted[[1]]
use_samples <- use_colData %>% 
  filter(immunogen_mmmodel %in% use_comps_i) %>% 
  pull(sample_alias)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData) %>% 
  filter(sample_alias %in% sample_ord)

use_assay$sample_alias <- factor(use_assay$sample_alias, 
                                 levels = sample_ord)
use_colors <- c(
  StealTHY_Imm.competent = '#F7EC13', StealTHY_Imm.deficient  = '#58595B',
  IC = '#F7EC13', ID  = '#58595B'
  )
use_assay %>%
  # filter(cpm <= 100000) %>%
  mutate(
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'StealTHY_Imm.competent', 'IC', NA),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'StealTHY_Imm.deficient', 'ID', immunogen_mmmodel)
    ) %>%
  # ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel, height = ..density..)) +
  # geom_density_ridges(color = 'black',
  #                     size = one_pt/4,
  #                     alpha = 0.8,
  #                     scale = 4,
  #                     rel_min_height = 0.005, # set the `rel_min_height` argument to remove tails,
  #                     stat = "density"
  #                     ) +
  ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel)) +
  geom_density_ridges(color = 'black',
                      size = one_pt/4,
                      alpha = 0.8,
                      scale = 4,
                      rel_min_height = 0.005 # set the `rel_min_height` argument to remove tails
                      ) +
  scale_fill_manual(values = use_colors) +
  scale_x_log10(expand = expansion(mult = c(0, 0))) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none') +
  # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y', space = 'free_y') +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black')
  )

```

#### Cumulative curves
Showing only top-1000 guides. Bright lines represent the average across the same group
```{r test-dist-tumor-distribution-cumsum_plot, fig.asp = 0.8}
use_comps_i <-comp_list_unlisted[[1]]
res_plot <- foreach(use_comps_i = comp_list_unlisted) %do% {
    use_samples <- use_colData %>% 
      filter(immunogen_mmmodel %in% use_comps_i) %>% 
      pull(sample_alias)
    use_assay <-  apply(assay(se[,use_samples], 'cpm'), 2, function(x) sort(x, decreasing = TRUE) %>% cumsum)  %>% 
      as.data.frame(check.names = F) %>% 
      mutate(guide = 1:nrow(se)) %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cumsum') %>% 
      left_join(use_colData)
    
    use_assay_average <-  use_assay %>% 
      group_by(guide, immunogen_mmmodel) %>% 
      summarise(cumsum = mean(cumsum))
    
    use_assay %>% 
      ggplot(aes(x=guide, y = cumsum, color = immunogen_mmmodel, group = sample_alias)) +
      geom_line(alpha = 0.3) +
      geom_line(data =use_assay_average, aes(x=guide, y = cumsum, color = immunogen_mmmodel, group = immunogen_mmmodel), linewidth = 1.2 ) +
      scale_fill_OkabeIto(alpha = 0.8) +
      scale_x_continuous(expand = c(0, 0), limits = c(0,1000)) +
      scale_y_continuous(expand = c(0, 0)) +
      scale_color_OkabeIto() +
      labs(
        y = 'Cumulative sum',
        x = 'rank',
        color = ''
      ) +
      theme(legend.position = 'top')
      # guides(color = 'none')
      # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y')
    
}

plot_grid(
  plotlist = res_plot, 
  labels = names(comp_list)
  )
```

### Selected density plots

#### Suppl. Figure 6D with log10 x-axis

```{r test-dist-tumor-distribution-ridges_plot-suppl-fig-6d-log10, fig.asp = 0.667, fig.width = 1.5625}

sample_ord <- rev(c(
  'A1Position_HumanPlate1',
  'A2Position_HumanPlate1',
  'E1Position_HumanPlate1',
  'E2Position_HumanPlate1',
  
  'A4Position_HumanPlate1',
  'E3Position_HumanPlate1',
  'E4Position_HumanPlate1',
  
  'A5Position_HumanPlate1',
  'A6Position_HumanPlate1',
  'E5Position_HumanPlate1',
  'E6Position_HumanPlate1',
  
  'A7Position_HumanPlate1',
  'A8Position_HumanPlate1',
  'E7Position_HumanPlate1',
  'E8Position_HumanPlate1',
  
  'A9Position_HumanPlate1',
  'A10Position_HumanPlate1',
  'E9Position_HumanPlate1',
  'E10Position_HumanPlate1'
  
  ))

use_assay <- assay(se[,sample_ord], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData)


use_assay$sample_alias <- factor(use_assay$sample_alias, 
                                 levels = sample_ord)

use_assay <- use_assay %>% 
  mutate(
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'dCas9-GFP_Imm.competent', 'C9-GFP IC', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'dCas9-GFP_Imm.deficient', 'C9-GFP ID', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'dCas9-THY_Imm.competent', 'C9-THY1 IC', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'GFP_Imm.competent', 'GFP IC', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'no_immunogen_Imm.competent', 'No Immmunogen IC', immunogen_mmmodel)
    ) 

use_colors <- c(
  `dCas9-GFP_Imm.competent` = 'grey80',
  `dCas9-GFP_Imm.deficient` = 'black',
  `dCas9-THY_Imm.competent` = 'grey80',
  `GFP_Imm.competent` = 'black',
  `no_immunogen_Imm.competent` = '#F7EC13',
  
  `C9-GFP IC` = 'grey80',
  `C9-GFP ID` = 'black',
  `C9-THY1 IC` = 'grey80',
  `GFP IC` = 'black',
  `No Immmunogen IC` = '#F7EC13'
  )

use_line_colors <- c(
  `dCas9-GFP_Imm.competent` = 'black',
  `dCas9-GFP_Imm.deficient` = 'white',
  `dCas9-THY_Imm.competent` = 'black',
  `GFP_Imm.competent` = 'white',
  `no_immunogen_Imm.competent` = 'black',
  
  `C9-GFP IC` = 'black',
  `C9-GFP ID` = 'white',
  `C9-THY1 IC` = 'black',
  `GFP IC` = 'white',
  `No Immmunogen IC` = 'black'
  )




use_assay %>%
  ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel, color = immunogen_mmmodel)) +
  geom_density_ridges(
                      size = one_pt/4,
                      alpha = 0.8,
                      scale = 4,
                      rel_min_height = 0.005 # set the `rel_min_height` argument to remove tails
                      ) +
  scale_fill_manual(values = use_colors) +
  scale_color_manual(values = use_line_colors) +
  scale_x_log10(expand = expansion(mult = c(0, 0))) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none', color = 'none') +
  # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y', space = 'free_y') +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.text.y = element_text(size=2),
    axis.text.x = element_text(size=8)
  )
```

#### Suppl. Figure 6D with logicle x-axis

```{r test-dist-tumor-distribution-ridges_plot-suppl-fig-6d-logicle, fig.asp = 0.667, fig.width = 1.5625}

sample_ord <- rev(c(
  'A1Position_HumanPlate1',
  'A2Position_HumanPlate1',
  'E1Position_HumanPlate1',
  'E2Position_HumanPlate1',
  
  'A4Position_HumanPlate1',
  'E3Position_HumanPlate1',
  'E4Position_HumanPlate1',
  
  'A5Position_HumanPlate1',
  'A6Position_HumanPlate1',
  'E5Position_HumanPlate1',
  'E6Position_HumanPlate1',
  
  'A7Position_HumanPlate1',
  'A8Position_HumanPlate1',
  'E7Position_HumanPlate1',
  'E8Position_HumanPlate1',
  
  'A9Position_HumanPlate1',
  'A10Position_HumanPlate1',
  'E9Position_HumanPlate1',
  'E10Position_HumanPlate1'
  
  ))

use_assay <- assay(se[,sample_ord], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData)


use_assay$sample_alias <- factor(use_assay$sample_alias, 
                                 levels = sample_ord)

use_assay <- use_assay %>% 
  mutate(
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'dCas9-GFP_Imm.competent', 'C9-GFP IC', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'dCas9-GFP_Imm.deficient', 'C9-GFP ID', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'dCas9-THY_Imm.competent', 'C9-THY1 IC', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'GFP_Imm.competent', 'GFP IC', immunogen_mmmodel),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'no_immunogen_Imm.competent', 'No Immmunogen IC', immunogen_mmmodel)
    ) 

use_colors <- c(
  `dCas9-GFP_Imm.competent` = 'grey80',
  `dCas9-GFP_Imm.deficient` = 'black',
  `dCas9-THY_Imm.competent` = 'grey80',
  `GFP_Imm.competent` = 'black',
  `no_immunogen_Imm.competent` = '#F7EC13',
  
  `C9-GFP IC` = 'grey80',
  `C9-GFP ID` = 'black',
  `C9-THY1 IC` = 'grey80',
  `GFP IC` = 'black',
  `No Immmunogen IC` = '#F7EC13'
  )

use_line_colors <- c(
  `dCas9-GFP_Imm.competent` = 'black',
  `dCas9-GFP_Imm.deficient` = 'white',
  `dCas9-THY_Imm.competent` = 'black',
  `GFP_Imm.competent` = 'white',
  `no_immunogen_Imm.competent` = 'black',
  
  `C9-GFP IC` = 'black',
  `C9-GFP ID` = 'white',
  `C9-THY1 IC` = 'black',
  `GFP IC` = 'white',
  `No Immmunogen IC` = 'black'
  )




use_assay %>%
  ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel, color = immunogen_mmmodel)) +
  geom_density_ridges(
                      size = one_pt/4,
                      alpha = 0.8,
                      scale = 4,
                      rel_min_height = 0.005 # set the `rel_min_height` argument to remove tails
                      ) +
  scale_fill_manual(values = use_colors) +
  scale_color_manual(values = use_line_colors) +
  ggcyto::scale_x_logicle(t = 1e3, 
                          expand = expansion(mult = c(0, 0)),
                          breaks = c(1, 1e2, 1e3, 1e4)) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none', color = 'none') +
  # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y', space = 'free_y') +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.text.y = element_text(size=2),
    axis.text.x = element_text(size=8)
  )
```


## Lung metastasis samples
Analysis 4 : Please perform unpaired comparison tests for (1) the total no. of detected sgRNAs and (2) distribution between the following lung metastasis samples
```{r test-dist-lung-conf}
use_sample_type <- 'whole_lung'
comp_list <- comp_list_by_sample_type
comp_list_unlisted <- foreach(x = comp_list, .combine = c) %do% x
comp_list_df_double <- foreach(x = comp_list_unlisted, .combine = rbind) %do% {rbind(x, rev(x))} %>% 
  data.frame %>% 
  set_names(c('group1', 'group2'))
use_colData <- colData(se) %>% data.frame %>% 
    filter(sample_type == use_sample_type)
```

### Number of detected guides

#### Table
```{r test-dist-lung-detected-tab}
comp_guides_detected %>% 
  filter(sample_type == use_sample_type) %>% 
  mutate(
    p = format.pval(p),
    p.adj = format.pval(p.adj),
  ) %>% 
  dplyr::select(-sample_type, -p.format, -.y.) %>% 
  inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide abundance. P value by two-sided Wiloxon test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Boxplot
```{r test-dist-lung-detected-boxplot, fig.width=2, fig.asp = 1.5}
comp_name <-  names(comp_list)[1]
res_plot <- foreach(comp_name = names(comp_list)) %do% {
  use_comps <-  comp_list[[comp_name]]
  use_colData %>% 
    filter(immunogen_mmmodel %in% unlist(use_comps)) %>% 
    mutate(immunogen_mmmodel = factor(immunogen_mmmodel, levels = unlist(use_comps))) %>% 
    ggplot(aes(immunogen_mmmodel, guides_over_30, color = immunogen_mmmodel)) +
      geom_boxplot(outlier.shape = NA) + 
      geom_beeswarm() +
      scale_y_continuous(expand = expansion(0.1)) +
      scale_color_brewer(type = 'qual', palette = 'Paired') +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
      stat_compare_means(comparisons = use_comps, method = 'wilcox.test') +
      labs(
        x = ''
      ) +
      guides(
        color = 'none'
      )
}
plot_grid(plotlist = res_plot, labels =  names(comp_list))
```


### Guide distribution

#### Table
We compared the distribution of guides abundances for each group using two-sided Kolmogorov-Smirnov (K-S) test. For each sample we ranked guides based on normalized abundance (CPM) distribution. Then the corresponding value for each rank was obtained averaging the CPM in samples from each group. 
```{r test-dist-lung-distribution-tab}
comp_abundance_dist %>% 
  filter(sample_type == use_sample_type) %>% 
  mutate(
    p.value = format.pval(p.value),
  ) %>% 
  dplyr::select(-sample_type) %>% 
  inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide distribution using two-sided Kolmogorov-Smirnov (K-S) test.',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Density plot
```{r test-dist-lung-distribution-ridges_plot, fig.asp = 1, fig.width = 5.2}
use_comps_i <- comp_list_unlisted[1]
res_plot <- foreach(use_comps_i = comp_list_unlisted) %do% {
    use_samples <- use_colData %>% 
      filter(immunogen_mmmodel %in% use_comps_i) %>% 
      pull(sample_alias)
    use_assay <- assay(se[,use_samples], 'cpm') %>% 
      as.data.frame(check.names = F) %>% 
      rownames_to_column('guide') %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData)
    use_assay %>% 
      # mutate(sample_alias = fct_reorder(sample_alias, use_comps_i)) %>%
      ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel)) +
      geom_density_ridges(color = 'white', quantile_lines = TRUE) +
      scale_fill_OkabeIto(alpha = 0.8) +
      scale_x_log10(expand = c(0, 0)) +
      scale_y_discrete(expand = c(0, 0)) +
      labs(y = '') +
      guides(fill = 'none') +
      facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y') +
      theme_ridges()
}


plot_grid(
  plotlist = res_plot, 
  labels = names(comp_list)
  )
```

#### Density plot StealTHY IC vs ID
```{r test-dist-lung-distribution-ridges_plot-stealthy-ic-id, fig.asp = 0.667, fig.width = 1.5625}
sample_ord <- rev(c(
  # 'Replacement_Sample5',
  'D1Position_HumanPlate2',
  'D2Position_HumanPlate2',
  'F2Position_HumanPlate2',
  'H1Position_HumanPlate2',
  'F1Position_HumanPlate2',
  'B2Position_HumanPlate2',
  
  'D4Position_HumanPlate2',
  'B4Position_HumanPlate2',
  'H3Position_HumanPlate2',
  'B3Position_HumanPlate2',
  'G3Position_HumanPlate2',
  'D3Position_HumanPlate2',
  'F3Position_HumanPlate2'
  ))

use_comps_i <- comp_list_unlisted[[1]]
use_samples <- use_colData %>% 
  filter(immunogen_mmmodel %in% use_comps_i) %>% 
  pull(sample_alias)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData) %>% 
  filter(sample_alias %in% sample_ord)

use_assay$sample_alias <- factor(use_assay$sample_alias, 
                                 levels = sample_ord)
use_colors <- c(
  StealTHY_Imm.competent = '#F7EC13', StealTHY_Imm.deficient  = '#58595B',
  IC = '#F7EC13', ID  = '#58595B'
  )

use_assay %>% 
  filter(cpm <= 100000) %>%
  mutate(
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'StealTHY_Imm.competent', 'IC', NA),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'StealTHY_Imm.deficient', 'ID', immunogen_mmmodel)
    ) %>%
  # ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel, height = ..density..)) +
  # geom_density_ridges(color = 'black',
  #                     size = one_pt/4,
  #                     alpha = 0.8,
  #                     scale = 4,
  #                     rel_min_height = 0.005, # set the `rel_min_height` argument to remove tails,
  #                     stat = "density"
  #                     ) +
  ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel)) +
  geom_density_ridges(color = 'black',
                      size = one_pt/4,
                      alpha = 0.8,
                      scale = 4,
                      rel_min_height = 0.005 # set the `rel_min_height` argument to remove tails
                      ) +
  scale_fill_manual(values = use_colors) +
  scale_x_log10(expand = expansion(mult = c(0, 0))
                # breaks = c(1, 10, 1000, 100000)
                ) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none') +
  # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y', space = 'free_y') +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black')
  )
```


#### Cumulative curves
Showing only top-1000 guides. Bright lines represent the average across the same group
```{r test-dist-lung-distribution-cumsum_plot, fig.asp = 0.8}
use_comps_i <-comp_list_unlisted[[1]]
res_plot <- foreach(use_comps_i = comp_list_unlisted) %do% {
    use_samples <- use_colData %>% 
      filter(immunogen_mmmodel %in% use_comps_i) %>% 
      pull(sample_alias)
    use_assay <-  apply(assay(se[,use_samples], 'cpm'), 2, function(x) sort(x, decreasing = TRUE) %>% cumsum)  %>% 
      as.data.frame(check.names = F) %>% 
      mutate(guide = 1:nrow(se)) %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cumsum') %>% 
      left_join(use_colData)
    use_assay_average <-  use_assay %>% 
      group_by(guide, immunogen_mmmodel) %>% 
      summarise(cumsum = mean(cumsum))
    
  use_assay %>% 
      ggplot(aes(x=guide, y = cumsum, color = immunogen_mmmodel, group = sample_alias)) +
      geom_line(alpha = 0.3) +
      geom_line(data =use_assay_average, aes(x=guide, y = cumsum, color = immunogen_mmmodel, group = immunogen_mmmodel), linewidth = 1.2 ) +
      scale_fill_OkabeIto(alpha = 0.8) +
      scale_x_continuous(expand = c(0, 0), limits = c(0,1000)) +
      scale_y_continuous(expand = c(0, 0)) +
      scale_color_OkabeIto() +
      labs(
        y = 'Cumulative sum',
        x = 'rank',
        color = ''
      ) +
      theme(legend.position = 'top')
      # guides(color = 'none')
      # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y')
}


plot_grid(
  plotlist = res_plot, 
  labels = names(comp_list)
  )
```


## Gini index

### huTHY-GFP-C9Thy-C9GFP
```{r test-dist-gini-index-huTHY-GFP-C9Thy-C9GFP, fig.width = 4.2}
use_colData <- colData(se) %>% data.frame %>% 
  filter(immunogen != 'no_immunogen') %>% 
  filter(sample_type != 'In vitro') %>% 
  mutate(
    sample_type = factor(sample_type, 
                         levels = c('whole_tumor', 
                                    'whole_lung', 
                                    'met_lymph', 
                                    'met_liver')
                         ),
    sample_type = recode_factor(sample_type,
                                'whole_tumor' = 'Primary\ntumor',
                                'whole_lung' = 'Metastasis\nlung',
                                'met_lymph' = 'Metastasis\nlymphnode',
                                'met_liver' = 'Metastasis\nliver'
                                ),
    immunogen = factor(immunogen, levels = c('StealTHY', 
                                             'GFP', 
                                             'dCas9-THY',
                                             'dCas9-GFP')
                       ),
    immunogen = recode_factor(immunogen,
                                'StealTHY' = 'huThy',
                                'GFP' = 'GFP',
                                'dCas9-THY' = 'C9-Thy',
                                'dCas9-GFP' = 'C9-GFP'
                                )
  )



          
use_colors <- c(
  huThy = '#F7EC13',
  # GFP = '#00f900',
  GFP = 'black',
  `C9-Thy`= 'grey80',
  `C9-GFP` = 'black'
)

use_shapes <- c(
  huThy = 21,
  GFP = 21,
  `C9-Thy`= 24,
  `C9-GFP` = 24
)

use_colData %>% 
  ggplot(aes(immunogen, gini_index)) +
  geom_violin(color = 'grey60', scale = "width",
              draw_quantiles = 0.5,
              linewidth = one_pt/2) +
  geom_quasirandom(aes(fill = immunogen, shape = immunogen),
                   color = 'black',
                   alpha = 0.8,
                   size = 1.5,
                   stroke = one_pt/2, width = 0.5) +
  scale_fill_manual(values = use_colors) +
  scale_shape_manual(values = use_shapes) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(expand = c(0.05, 0)) +
  facet_grid(cols = vars(sample_type), scale = 'free', space = 'free') +
  # facet_grid(cols = vars(sample_type)) +
  theme_facet +
  labs(
    x = '',
    y = 'Gini index'
  ) +
  guides(
    fill = 'none',
    shape = 'none'
  )
```

### no_immunogen-GFP-C9Thy-C9GFP
```{r test-dist-gini-index-no_immunogen-GFP-C9Thy-C9GFP, fig.width = 4.2}
use_colData <- colData(se) %>% data.frame %>% 
  filter(immunogen != 'StealTHY') %>% 
  filter(sample_type != 'In vitro') %>% 
  mutate(
    sample_type = factor(sample_type, 
                         levels = c('whole_tumor', 
                                    'whole_lung', 
                                    'met_lymph', 
                                    'met_liver')
                         ),
    sample_type = recode_factor(sample_type,
                                'whole_tumor' = 'Primary\ntumor',
                                'whole_lung' = 'Metastasis\nlung',
                                'met_lymph' = 'Metastasis\nlymphnode',
                                'met_liver' = 'Metastasis\nliver'
                                ),
    immunogen = factor(immunogen, levels = c('no_immunogen', 
                                             'GFP', 
                                             'dCas9-THY',
                                             'dCas9-GFP')
                       ),
    immunogen = recode_factor(immunogen,
                                'no_immunogen' = 'No immunogen',
                                'GFP' = 'GFP',
                                'dCas9-THY' = 'C9-Thy',
                                'dCas9-GFP' = 'C9-GFP'
                                )
  )



          
use_colors <- c(
  `No immunogen` = '#F7EC13',
  # GFP = '#00f900',
  GFP = 'black',
  `C9-Thy`= 'grey80',
  `C9-GFP` = 'black'
)

use_shapes <- c(
  `No immunogen` = 21,
  GFP = 21,
  `C9-Thy`= 24,
  `C9-GFP` = 24
)

use_colData %>% 
  ggplot(aes(immunogen, gini_index)) +
  geom_violin(color = 'grey60', scale = "width",
              draw_quantiles = 0.5,
              linewidth = one_pt/2) +
  geom_quasirandom(aes(fill = immunogen, shape = immunogen),
                   color = 'black',
                   alpha = 0.8,
                   size = 1.5,
                   stroke = one_pt/2, width = 0.5) +
  scale_fill_manual(values = use_colors) +
  scale_shape_manual(values = use_shapes) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(expand = c(0.05, 0)) +
  facet_grid(cols = vars(sample_type), scale = 'free', space = 'free') +
  # facet_grid(cols = vars(sample_type)) +
  theme_facet +
  labs(
    x = '',
    y = 'Gini index'
  ) +
  guides(
    fill = 'none',
    shape = 'none'
  )
```

### huTHY-C9GFP
```{r test-dist-gini-index-huTHY-C9GFP}
use_colData <- colData(se) %>% data.frame %>% 
  filter(immunogen %in% c('StealTHY','dCas9-GFP')) %>% 
  filter(sample_type != 'In vitro') %>% 
  mutate(
    sample_type = factor(sample_type, 
                         levels = c('whole_tumor', 
                                    'whole_lung', 
                                    'met_lymph', 
                                    'met_liver')
                         ),
    sample_type = recode_factor(sample_type,
                                'whole_tumor' = 'Primary\ntumor',
                                'whole_lung' = 'Metastasis\nlung',
                                'met_lymph' = 'Metastasis\nlymphnode',
                                'met_liver' = 'Metastasis\nliver'
                                ),
    immunogen = factor(immunogen, levels = c('StealTHY', 
                                             'GFP', 
                                             'dCas9-THY',
                                             'dCas9-GFP')
                       ),
    immunogen = recode_factor(immunogen,
                                'StealTHY' = 'huThy',
                                'GFP' = 'GFP',
                                'dCas9-THY' = 'C9-Thy',
                                'dCas9-GFP' = 'C9-GFP'
                                )
  )



          
use_colors <- c(
  huThy = '#F7EC13',
  # GFP = '#00f900',
  GFP = 'black',
  `C9-Thy`= 'grey80',
  `C9-GFP` = 'black'
)

use_shapes <- c(
  huThy = 21,
  GFP = 21,
  `C9-Thy`= 24,
  `C9-GFP` = 24
)

use_colData %>% 
  ggplot(aes(immunogen, gini_index)) +
  geom_violin(color = 'grey60', scale = "width",
              draw_quantiles = 0.5,
              linewidth = one_pt/2) +
  geom_quasirandom(aes(fill = immunogen, shape = immunogen),
                   color = 'black',
                   alpha = 0.8,
                   size = 1.5,
                   stroke = one_pt/2, width = 0.5) +
  scale_fill_manual(values = use_colors) +
  scale_shape_manual(values = use_shapes) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_y_continuous(expand = c(0.05, 0)) +
  facet_grid(cols = vars(sample_type), scale = 'free', space = 'free') +
  # facet_grid(cols = vars(sample_type)) +
  theme_facet +
  labs(
    x = '',
    y = 'Gini index'
  ) +
  guides(
    fill = 'none',
    shape = 'none'
  )
```



## Modality

### Test for Multimodality
Different test for modality were performed by sample:

- Hartigans' dip test for unimodality / multimodality. If the p-value is less than 0.05, there's enough evidence to claim that the data are not unimodal (multimodal, at least bimodal).

- LaplacesDemon: test for bimodality, trimodality and number of modes.

- Mousetrap Bimodality test

```{r test-modality}
library(diptest)
library(LaplacesDemon)
library(mousetrap)

use_assay <- assay(se, 'cpm')
i <- colnames(use_assay)[1]
modality_test_df <- foreach(i= colnames(use_assay), .combine = rbind) %do%{
  x <- use_assay[,i]
  dip.res <- dip.test(x, simulate.p.value = FALSE, B = 2000)
  data.frame(sample_alias = i,
    dip.D = dip.res$statistic, #diptest
    dip.p = dip.res$p.value, #diptest
    dip.result = ifelse(dip.res$p.value < 0.05, 'multimodal', 'unimodal'), #diptest
    ld.multimodal = is.multimodal(x), #LaplacesDemon
    ld.bimodal = is.bimodal(x), #LaplacesDemon
    ld.trimodal = is.trimodal(x), #LaplacesDemon
    ld.n.modes = length(Modes(x)$modes), #LaplacesDemon
    pfister.bimodality.coeff = bimodality_coefficient(x), #mousetrap
    pfister.bimodal = bimodality_coefficient(x) > 0.555  #mousetrap
    )
}

modality_test_df %<>% 
  left_join(colData(se) %>% data.frame)
```

#### Hartigan's dip test 

##### Plot
```{r modality-dip-test-plot, fig.width = 3, fig.asp = 0.666}
modality_test_df %>% 
  filter(sample_type %in% c('In vitro', 'whole_tumor', 'whole_lung')) %>%
  mutate(
    sample_type = factor(sample_type, levels = c('In vitro', 'whole_tumor', 'whole_lung')),
    mm_model_type = recode_factor(mm_model_type, `Imm.competent` = 'IC', `Imm.deficient` = 'NSG')
    ) %>% 
  ggplot(aes(x = immunogen_mmmodel, y = dip.D)) +
  geom_boxplot(
    # alpha = 0.6,
    linewidth = one_pt/4,
    outlier.shape = NA) +
  geom_quasirandom(
    aes(color =  dip.result),
    alpha = 0.6,
    pch = 16,
    size = 0.7
    
  ) +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  facet_grid(cols = vars(sample_type, mm_model_type), scales = 'free_x', space = 'free_x') +
  theme_facet +
  labs(
    x = '',
    y = 'Dip test statistic'
  ) +
  theme(
    text = element_text(size=3),
    axis.text.y =  element_text(size=3),
    axis.text.x =  element_text(size=3),
    axis.line = element_line(linewidth = one_pt/4, color = 'black'),
    axis.ticks = element_line(linewidth = one_pt/4, color = 'black'),
    panel.border = element_rect(fill =NULL, color = "black",
                                linewidth = one_pt/4)
  )

```

##### Summary
```{r modality-dip-test-summary, fig.width = 3, fig.asp = 0.666}
modality_test_df %>% 
  filter(sample_type %in% c('In vitro', 'whole_tumor', 'whole_lung')) %>%
  mutate(
    sample_type = factor(sample_type, levels = c('In vitro', 'whole_tumor', 'whole_lung')),
    mm_model_type = recode_factor(mm_model_type, `Imm.competent` = 'IC', `Imm.deficient` = 'NSG')
    ) %>% 
  group_by(sample_type, mm_model_type) %>% 
  summarise(
    n = n(),
    multimodal = sum(dip.result == 'multimodal'),
    unimodal = sum(dip.result == 'unimodal'),
    median.dip.D = median(dip.D)
  ) %>% 
  kbl(caption = 'Summary stats for Hartigan dip test by model') %>%
  kable_paper(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
```

##### Data
```{r modality-dip-test-data, fig.width = 3, fig.asp = 0.666}
modality_test_df %>% 
  filter(sample_type %in% c('In vitro', 'whole_tumor', 'whole_lung')) %>%
  mutate(
    sample_type = factor(sample_type, levels = c('In vitro', 'whole_tumor', 'whole_lung')),
    mm_model_type = recode_factor(mm_model_type, `Imm.competent` = 'IC', `Imm.deficient` = 'NSG')
    ) %>% 
  dplyr::select(sample_alias, sample_type, mm_model_type, dip.D, dip.p, dip.result) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Hartigan dip test results by sample',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```


### Comparisons table
```{r modality-comparisons-table}
data_comp <- foreach(i = names(comp_list_modality), .combine = rbind) %do% {
  c(
    Comparison = i,
    Case = paste(comp_list_modality[[i]][[1]], collapse = " "),
    Control = paste(comp_list_modality[[i]][[2]], collapse = " ")
  )
}

data_comp %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of modality test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:2)
              )
            )
            )

```

### Kolmogorov-Smirnov test

Run Kolmogorov-Smirnov test to compare distributions merged by group and create Empirical Cumulative Density Function (ECDF) by comparison.
```{r modality-comparisons-ks-run}
i <- names(comp_list_modality)[1]
ks_test_df <- data.frame()
ecdf_plots <- list()
for(i in names(comp_list_modality)) {
  use_samples <- comp_list_modality[[i]]
  use_assay_c <- assay(se[,use_samples[[1]]], 'cpm') %>% 
    data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, values_to = 'cpm',names_to = 'sample_alias') %>% 
    mutate(group = 'case', condition = names(use_samples)[1])
  use_assay_r <- assay(se[,use_samples[[2]]], 'cpm') %>% 
    data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, values_to = 'cpm',names_to = 'sample_alias') %>% 
    mutate(group = 'referene', condition = names(use_samples)[2])
  use_assay <- rbind(use_assay_c, use_assay_r)
  
  # Perform the Kolmogorov-Smirnov test
  ks.res <- ks.test(use_assay_c$cpm, use_assay_r$cpm)
  ks_test_df <- rbind(
    ks_test_df,
      data.frame(
      comparison = i,
      case = names(use_samples)[1],
      reference = names(use_samples)[2],
      ks.D = ks.res$statistic,
      ks.P = ks.res$p.value
    )
  )

  # Create ECDFs plot Empirical Cumulative Density Function
  use_colors <- c('red', 'blue') %>% set_names(names(use_samples))
  ecdf_plots[[i]] <- use_assay %>% 
    ggplot(aes(x = log(1+cpm), color = condition, group = sample_alias)) +
    stat_ecdf(geom = 'step', alpha = 0.8, size = one_pt/4) +
    scale_color_manual(values = use_colors) +
    labs(x = "log(1+cpm)",
         color = '',
         sub = i,
         caption =paste("Kolmogorov-Smirnov test p-value:", round(ks.res$p.value, 3), "\n",
                        "Kolmogorov-Smirnov test D:", round(ks.res$statistic, 3))) +
    theme(
      text = element_text(size=2),
      axis.line = element_line(linewidth = one_pt/4, color = 'black'),
      axis.ticks = element_line(linewidth = one_pt/4, color = 'black'),
      axis.text.y =  element_text(size=3),
      axis.text.x =  element_text(size=3),
      legend.text =  element_text(size=2),
      legend.title =  element_text(size=2),
      plot.subtitle = element_text(size=3),
      plot.caption =  element_text(size=2)
      
    )

}
```

#### Table K-S


Kolmogorov-Smirnov test results
```{r modality-comparisons-ks-table}
ks_test_df %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Results of Kolmogorov-Smirnov test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel'),
              columnDefs = list(
                list(width = 120, targets = 1:3)
              )
            )
            ) %>% 
    formatRound(columns = c('ks.D'), digits = 3) %>% 
    formatSignif(columns = c('ks.P'), digits = 3)

```

#### ECDF plots

Empirical Cumulative Density Function (ECDF) plot by comparison

```{r modality-comparisons-ks-ecdf, fig.width = 1.5, fig.asp = 0.66}
for(i in names(ecdf_plots)) {
  cat("#####", i, "\n")
  print(ecdf_plots[[i]])
  cat("\n\n")
}
```



## Additional comparisons

Run individual test comparisons between hu samples not KO, hence producing individual sgRNA distributions (see excel file)
```{r test-dist-additional-conf}
comp_list <- comp_list_additional
comp_list_unlisted <- foreach(x = comp_list, .combine = c) %do% x
# comp_list_df_double <- foreach(x = comp_list_unlisted, .combine = rbind) %do% {rbind(x, rev(x))} %>% 
#   data.frame %>% 
#   set_names(c('group1', 'group2'))
use_colData <- colData(se) %>% data.frame 

# Set colors
group_levels <- map(comp_list, names) %>% unlist %>% sub("^[A-Z]+\\.", "", .) %>% unique
group_color_palette <- ifelse(grepl('No_immunogen',group_levels), '#F7EC13', NA)
group_color_palette <- ifelse(grepl('GFP',group_levels), 'grey80', group_color_palette)
group_color_palette <- ifelse(grepl('Cas9',group_levels), 'black', group_color_palette)
names(group_color_palette) <- group_levels

group_levels <- map(comp_list, names) %>% unlist %>% sub("^[A-Z]+\\.", "", .) %>% unique
group_line_color <- ifelse(grepl('No_immunogen',group_levels), 'black', NA)
group_line_color <- ifelse(grepl('GFP',group_levels), 'black', group_line_color)
group_line_color <- ifelse(grepl('Cas9',group_levels), 'white', group_line_color)
names(group_line_color) <- group_levels

```

### Number of detected guides

#### Table
```{r test-dist-additional-detected-tab}
comp_guides_detected_additional %>% 
  mutate(
    p = format.pval(p),
    p.adj = format.pval(p.adj),
  ) %>% 
  dplyr::select(-p.format, -.y.) %>% 
  # inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide abundance. P value by two-sided Wiloxon test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Boxplot
```{r test-dist-additional-detected-boxplot, fig.width=2, fig.asp = 1.5}
comp_name <-  names(comp_list)[1]

# res_plot <- foreach(comp_name = names(comp_list)) %do% {
#   use_comps <-  comp_list[[comp_name]]
#   use_colData %>% 
#     mutate(
#       group = ifelse(sample_alias %in% use_comps[[1]], names(use_comps)[1], NA),
#       group = ifelse(sample_alias %in% use_comps[[2]], names(use_comps)[2], group),
#       group = factor(group, levels = names(use_comps)[1:2])
#     ) %>% 
#     filter(!is.na(group)) %>% 
#     ggplot(aes(group, guides_over_30, color = group)) +
#       geom_boxplot(outlier.shape = NA) + 
#       geom_beeswarm() +
#       scale_y_continuous(expand = expansion(0.1)) +
#       # scale_color_brewer(type = 'qual', palette = 'Paired') +
#     scale_color_manual(values = group_color_palette) +
#       theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
#       stat_compare_means(comparisons = list(names(use_comps)[1:2]), method = 'wilcox.test', size = geom_text_size) +
#       labs(
#         x = ''
#       ) +
#       guides(
#         color = 'none'
#       )
# }
# names(res_plot) <- names(comp_list)
# plot_grid(plotlist = res_plot, labels =  names(comp_list), align = 'hv')

for(comp_name in names(comp_list)) {
  cat("#####", comp_name, "\n\n")
  use_comps <-  comp_list[[comp_name]]
  res <- use_colData %>% 
    mutate(
      group = ifelse(sample_alias %in% use_comps[[1]], names(use_comps)[1], NA),
      group = ifelse(sample_alias %in% use_comps[[2]], names(use_comps)[2], group),
      group = factor(group, levels = names(use_comps)[1:2])
    ) %>% 
    filter(!is.na(group)) %>% 
    ggplot(aes(group, guides_over_30, color = group)) +
      geom_boxplot(outlier.shape = NA) + 
      geom_beeswarm() +
      scale_y_continuous(expand = expansion(0.1)) +
      # scale_color_brewer(type = 'qual', palette = 'Paired') +
    scale_color_manual(values = group_color_palette) +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
      stat_compare_means(comparisons = list(names(use_comps)[1:2]), method = 'wilcox.test', size = geom_text_size) +
      labs(
        x = '', 
        title = comp_name
      ) +
      guides(
        color = 'none'
      )
  print(res)
  cat("\n\n")
}
```


### Guide distribution

#### Table
We compared the distribution of guides abundances for each group using two-sided Kolmogorov-Smirnov (K-S) test. For each sample we ranked guides based on normalized abundance (CPM) distribution. Then the corresponding value for each rank was obtained averaging the CPM in samples from each group. 
```{r test-dist-additional-distribution-tab}
comp_abundance_dist %>% 
  mutate(
    p.value = format.pval(p.value),
  ) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide distribution using two-sided Kolmogorov-Smirnov (K-S) test.',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Density plots
```{r test-dist-additional-distribution-ridges_plot, fig.asp = 0.667, fig.width = 1.5625}
for(comp_name in names(comp_list)) {
  cat("#####", comp_name, "\n\n")
  use_comps <-  comp_list[[comp_name]]
  chunk_colData <- use_colData %>% 
    mutate(
      group = ifelse(sample_alias %in% use_comps[[1]], names(use_comps)[1], NA),
      group = ifelse(sample_alias %in% use_comps[[2]], names(use_comps)[2], group),
      group = factor(group, levels = names(use_comps)[1:2]),
    ) %>% 
    filter(!is.na(group)) 
  use_assay <- assay(se[,chunk_colData$sample_alias], 'cpm') %>% 
    as.data.frame(check.names = F) %>% 
    rownames_to_column('guide') %>% 
    pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
    left_join(chunk_colData) %>% 
    mutate(
      sample_alias = factor(sample_alias, levels = use_comps %>% unlist()),
    )
    
  
  res <- use_assay %>%
    ggplot(aes(x=cpm + 1, y = sample_alias, fill = group, color = group)) +
    geom_density_ridges(
                        size = one_pt/4,
                        alpha = 0.8,
                        scale = 4,
                        rel_min_height = 0.005 # set the `rel_min_height` argument to remove tails
                        ) +
    scale_fill_manual(values = group_color_palette) +
    scale_color_manual(values = group_line_color) +
    scale_x_log10(expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = c(0.01, 0)) +
    labs(y = '', title = comp_name) +
    guides(fill = 'none', color = 'none') +
    # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y', space = 'free_y') +
    theme_ridges(font_size = 3, grid = F) +
    theme(
      strip.background = element_blank(),
      axis.line.x = element_line(linewidth = one_pt/4, color = 'black'),
      axis.ticks.x = element_line(linewidth = one_pt/4, color = 'black'),
      axis.text.y = element_text(size=2),
      axis.text.x = element_text(size=8),
      
      plot.title = element_text(size=8)
    ) +
    facet_grid(rows = vars(group), scales = 'free_y', space = 'free_y')
  
  print(res)
  cat("\n\n")
}
```

## Stop knitr
```{r}
knitr::knit_exit()
```




## Global comparisons
Analysis 5 : Please perform unpaired comparison tests for (1) the total no. of detected sgRNAs and (2) distribution between the following global summaries 
```{r test-dist-global-conf}
# comp_list <- comp_list_global
# comp_list_unlisted <- foreach(x = comp_list, .combine = c) %do% x
# comp_list_df_double <- foreach(x = comp_list_unlisted, .combine = rbind) %do% {rbind(x, rev(x))} %>% 
#   data.frame %>% 
#   set_names(c('group1', 'group2'))
# 
# 
# comp_list_2 <- comp_list_global_2
# comp_list_unlisted_2 <- foreach(x = comp_list_2, .combine = c) %do% x
# comp_list_df_double_2 <- foreach(x = comp_list_unlisted_2, .combine = rbind) %do% {rbind(x, rev(x))} %>% 
#   data.frame %>% 
#   set_names(c('group1', 'group2'))
comp_list <- comp_list_global
comp_list_unlisted <- foreach(x = comp_list, .combine = c) %do% x
comp_list_df_double <- foreach(x = comp_list_unlisted, .combine = rbind) %do% {rbind(x, rev(x))} %>%
  data.frame %>%
  set_names(c('group1', 'group2'))


use_colData <- colData(se) %>% data.frame

```

### Number of detected guides

#### Table
```{r test-dist-global-detected-tab}
comp_guides_detected %>% 
  filter(sample_type == use_sample_type) %>% 
  mutate(
    p = format.pval(p),
    p.adj = format.pval(p.adj),
  ) %>% 
  dplyr::select(-sample_type, -p.format, -.y.) %>% 
  inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide abundance. P value by two-sided Wiloxon test',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Boxplot
```{r test-dist-global-detected-boxplot, fig.width=2, fig.asp = 1.5}
comp_name <-  names(comp_list)[1]
res_plot <- foreach(comp_name = names(comp_list)) %do% {
  use_comps <-  comp_list[[comp_name]]
  use_colData %>% 
    filter(immunogen_mmmodel %in% unlist(use_comps)) %>% 
    mutate(immunogen_mmmodel = factor(immunogen_mmmodel, levels = unlist(use_comps))) %>% 
    ggplot(aes(immunogen_mmmodel, guides_over_30, color = immunogen_mmmodel)) +
      geom_boxplot(outlier.shape = NA) + 
      geom_beeswarm() +
      scale_y_continuous(expand = expansion(0.1)) +
      scale_color_brewer(type = 'qual', palette = 'Paired') +
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      stat_compare_means(comparisons = use_comps, method = 'wilcox.test') +
      labs(
        x = ''
      ) +
      guides(
        color = 'none'
      )
}
plot_grid(plotlist = res_plot, labels =  names(comp_list), align = 'hv')
```


### Guide distribution

#### Table
We compared the distribution of guides abundances for each group using two-sided Kolmogorov-Smirnov (K-S) test. For each sample we ranked guides based on normalized abundance (CPM) distribution. Then the corresponding value for each rank was obtained averaging the CPM in samples from each group. 
```{r test-dist-global-distribution-tab}
comp_abundance_dist %>% 
  filter(sample_type == use_sample_type) %>% 
  mutate(
    p.value = format.pval(p.value),
  ) %>% 
  dplyr::select(-sample_type) %>% 
  inner_join(comp_list_df_double) %>% 
  datatable(., 
            rownames = FALSE, 
            filter = 'top', 
            caption = 'Comparison of guide distribution using two-sided Kolmogorov-Smirnov (K-S) test.',
            extensions = 'Buttons', 
            options = list(
              dom = 'Blfrtip',
              buttons = c('csv', 'excel')
            ))

```

#### Density plot
```{r test-dist-global-distribution-ridges_plot, fig.asp = 1, fig.width = 5.2}
use_comps_i <- comp_list_unlisted[1]
res_plot <- foreach(use_comps_i = comp_list_unlisted) %do% {
    use_samples <- use_colData %>% 
      filter(immunogen_mmmodel %in% use_comps_i) %>% 
      pull(sample_alias)
    use_assay <- assay(se[,use_samples], 'cpm') %>% 
      as.data.frame(check.names = F) %>% 
      rownames_to_column('guide') %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
      left_join(use_colData)
    use_assay %>% 
      # mutate(sample_alias = fct_reorder(sample_alias, use_comps_i)) %>%
      ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel)) +
      geom_density_ridges(color = 'white', quantile_lines = TRUE) +
      scale_fill_OkabeIto(alpha = 0.8) +
      scale_x_log10(expand = c(0, 0)) +
      scale_y_discrete(expand = c(0, 0)) +
      labs(y = '') +
      guides(fill = 'none') +
      facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y') +
      theme_ridges()
}


plot_grid(
  plotlist = res_plot, ncol = 3, 
  labels = paste0(rep(names(comp_list), 3) %>% sort, 1:3)
  )
```

#### Density plot StealTHY IC vs ID
```{r test-dist-global-distribution-ridges_plot-stealthy-ic-id, fig.asp = 0.667, fig.width = 1.5625}
use_comps_i <- comp_list_unlisted[[1]]
use_samples <- use_colData %>% 
  filter(immunogen_mmmodel %in% use_comps_i) %>% 
  pull(sample_alias)
use_assay <- assay(se[,use_samples], 'cpm') %>% 
  as.data.frame(check.names = F) %>% 
  rownames_to_column('guide') %>% 
  pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cpm') %>% 
  left_join(use_colData)
sample_ord <- rev(c(
  'Replacement_Sample4',
  'C1Position_HumanPlate2',
  'C2Position_HumanPlate2',
  'E2Position_HumanPlate2',
  'E1Position_HumanPlate2',
  'G1Position_HumanPlate2',
  'A2Position_HumanPlate2',
  
  'C4Position_HumanPlate2',
  'C3Position_HumanPlate2',
  'G3Position_HumanPlate2',
  'E3Position_HumanPlate2',
  'A4Position_HumanPlate2',
  'A3Position_HumanPlate2'
  ))
use_assay$sample_alias <- factor(use_assay$sample_alias, 
                                 levels = sample_ord)
use_colors <- c(
  StealTHY_Imm.competent = '#F7EC13', StealTHY_Imm.deficient  = '#58595B',
  IC = '#F7EC13', ID  = '#58595B'
  )
use_assay %>% 
  # filter(cpm <= 100000) %>% 
  mutate(
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'StealTHY_Imm.competent', 'IC', NA),
    immunogen_mmmodel = ifelse(immunogen_mmmodel == 'StealTHY_Imm.deficient', 'ID', immunogen_mmmodel)
    ) %>% 
  ggplot(aes(x=cpm + 1, y = sample_alias, fill = immunogen_mmmodel, height = ..density..)) +
  geom_density_ridges(color = 'black', 
                      size = one_pt/4, 
                      alpha = 0.8, 
                      scale = 4,
                      rel_min_height = 0.005, # set the `rel_min_height` argument to remove tails,
                      stat = "density"
                      ) +
  scale_fill_manual(values = use_colors) +
  scale_x_log10(expand = expansion(mult = c(0, 0))
                # breaks = c(1, 10, 1000, 100000)
                ) +
  scale_y_discrete(expand = c(0.01, 0)) +
  labs(y = '') +
  guides(fill = 'none') +
  # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y', space = 'free_y') +
  theme_ridges(font_size = 3, grid = F) +
  theme(
    strip.background = element_blank(),
    axis.line.x = element_line(linewidth = one_pt/4, color = 'black')
  )
```

#### Cumulative curves
Showing only top-1000 guides. Bright lines represent the average across the same group
```{r test-dist-global-distribution-cumsum_plot, fig.asp = 0.8}
use_comps_i <-comp_list_unlisted[[1]]
res_plot <- foreach(use_comps_i = comp_list_unlisted) %do% {
    use_samples <- use_colData %>% 
      filter(immunogen_mmmodel %in% use_comps_i) %>% 
      pull(sample_alias)
    use_assay <-  apply(assay(se[,use_samples], 'cpm'), 2, function(x) sort(x, decreasing = TRUE) %>% cumsum)  %>% 
      as.data.frame(check.names = F) %>% 
      mutate(guide = 1:nrow(se)) %>% 
      pivot_longer(-guide, names_to = 'sample_alias', values_to = 'cumsum') %>% 
      left_join(use_colData)
    use_assay_average <-  use_assay %>% 
      group_by(guide, immunogen_mmmodel) %>% 
      summarise(cumsum = mean(cumsum))
    
  use_assay %>% 
      ggplot(aes(x=guide, y = cumsum, color = immunogen_mmmodel, group = sample_alias)) +
      geom_line(alpha = 0.3) +
      geom_line(data =use_assay_average, aes(x=guide, y = cumsum, color = immunogen_mmmodel, group = immunogen_mmmodel), linewidth = 1.2 ) +
      scale_fill_OkabeIto(alpha = 0.8) +
      scale_x_continuous(expand = c(0, 0), limits = c(0,1000)) +
      scale_y_continuous(expand = c(0, 0)) +
      scale_color_OkabeIto() +
      labs(
        y = 'Cumulative sum',
        x = 'rank',
        color = ''
      ) +
      theme(legend.position = 'top')
      # guides(color = 'none')
      # facet_grid(rows = vars(immunogen_mmmodel), scale = 'free_y')
}


plot_grid(
  plotlist = res_plot, 
  labels = names(comp_list)
  )
```




